# アニメーション終了後の処理

jQuery エフェクトを実装する際の一般的な誤りは、メソッドチェーン内の次のメソッドの実行がアニメーションが完了するまで待つと仮定することです。

```js
$("div.hidden").fadeIn(1500).addClass("lookAtMe");
```

上記の `.fadeIn()` はアニメーションを開始するだけであることに注意することが重要です。開始されると、アニメーションは JavaScript の `setInterval()` ループで CSS プロパティを急速に変更することによって実装されます。`.fadeIn()` を呼び出すと、アニメーションループが開始され、その後 jQuery オブジェクトが返され、`.addClass()` に渡されます。そして、アニメーションループが始まったばかりの段階で `lookAtMe` スタイル クラスが追加されます。

アニメーションが完了した後に処理を延期するには、アニメーションコールバック関数を使用する必要があります。アニメーションコールバックを、上記で説明したアニメーションメソッドのいずれかに渡される 2 番目の引数として指定することができます。上記のコード スニペットでは、コールバックを次のように実装できます。

```js
// すべての非表示の段落をフェードインさせ、その後にスタイル クラスを追加する（アニメーションコールバックを使った正しい方法）
$("div.hidden").fadeIn(1500, function () {
  // this = アニメーションが完了した直後の DOM 要素
  $(this).addClass("lookAtMe");
});
```

アニメーション対象の DOM 要素を参照するために `this` キーワードを使用できることに注意してください。また、コールバックは jQuery オブジェクト内の各要素に対して呼び出されることにも注意してください。これは、セレクタが要素を返さない場合、アニメーションコールバックが決して実行されないことを意味します！この問題を解決するには、選択が要素を返したかどうかをテストします。返さなかった場合は、コールバックを直ちに実行することができます。

```js
// アニメーション対象の要素がなかった場合でもコールバックを実行する
var someElement = $("#nonexistent");

var cb = function () {
  console.log("done!");
};

if (someElement.length) {
  someElement.fadeIn(300, cb);
} else {
  cb();
}
```

> **Web 8080** タブを更新してウェブ ページをプレビューできます。
