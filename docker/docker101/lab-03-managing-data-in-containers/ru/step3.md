# [Необязательно] OverlayFS

OverlayFS — это реализация объединенного файлового systému (`union mount filesystem`) для Linux. Чтобы понять, что такое том Docker, полезно знать, как работают слои и файловая система в Docker.

Для запуска контейнера Docker берет образ с чтением только и создает поверх него новый слой с записью. Чтобы рассматривать слои как единый целый, Docker использует объединенную файловую систему или OverlayFS (Overlay File System), конкретно драйвер хранилища `overlay2`.

Чтобы увидеть файлы, управляемые Docker-хостом, вам нужно иметь доступ к файловой системе процесса Docker. С использованием флагов `--privileged` и `--pid=host` вы можете получить доступ к пространству имен идентификаторов процессов хоста изнутри контейнера, такого как `busybox`. Затем вы можете перейти по директории `/var/lib/docker/overlay2` Docker, чтобы увидеть загруженные слои, управляемые Docker.

Чтобы просмотреть текущий список слоев в Docker:

```bash
$ docker run -it --privileged --pid=host busybox nsenter -t 1 -m -u -n -i sh

/ # ls -l /var/lib/docker/overlay2
total 16
drwx------ 3 root root 4096 Sep 25 19:44 0e55ecaa4d17c353191e68022d9a17fde64fb5e9217b07b5c56eb4c74dad5b32
drwx------ 5 root root 4096 Sep 25 19:44 187854d05ccd18980642e820b0d2be6a127ba85d8ed96315bb5ae37eb1add36d
drwx------ 4 root root 4096 Sep 25 19:44 187854d05ccd18980642e820b0d2be6a127ba85d8ed96315bb5ae37eb1add36d-init
drwx------ 2 root root 4096 Sep 25 19:44 l

/ # exit
```

Скачайте образ `ubuntu` и проверьте снова:

```bash
docker pull ubuntu
docker run -it --privileged --pid=host busybox nsenter -t 1 -m -u -n -i sh
```

Введите команду, чтобы снова увидеть список слоев:

```
ls -l /var/lib/docker/overlay2/ & exit
```

Вы увидите, что при скачивании образа `ubuntu` неявно были скачаны 4 новых слоя:

- a611792b4cac502995fa88a888261dfba0b5d852e72f9db9e075050991423779
- d181f1a41fc35a45c16e8bfcb8eee6f768f3b98f82210a43ea65f284a45fcd65
- dac2f37f6280a076836d39b87b0ae5ebf5c0d386b6d8b991b103aadbcebaa7c6
- f3e921b440c37c86d06cd9c9fb70df50edad553c36cc87f84d5eeba734aae709

Драйвер хранилища `overlay2` по существу накладывает разные директории на хосте и представляет их в виде одной директории.

- базовый слой или lowerdir,
- слой `diff` или upperdir,
- слой overlay (представление пользователя), и
- директория `work`.

OverlayFS ссылается на нижние директории как `lowerdir`, которая содержит базовый образ и слои с чтением только (R/O), которые были загружены.

Верхняя директория называется `upperdir` и представляет собой слой контейнера с записью (R/W).

Объединенное представление или слой `overlay` называется `merged`.

Наконец, `workdir` является обязательной и представляет собой пустую директорию, используемую overlay для внутреннего использования.

Драйвер `overlay2` поддерживает до 128 нижних слоев OverlayFS. Директория `l` содержит сокращенные идентификаторы слоев в виде символических ссылок.

![Драйвер хранилища Overlay2](../assets/overlay2-driver.png)

Очистите:

```bash
docker system prune -a
clear
```
