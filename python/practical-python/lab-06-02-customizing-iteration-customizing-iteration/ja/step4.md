# 演習6.5：ストリーミングデータソースの監視

ジェネレータは、ログファイルや株価ニュースなどのリアルタイムデータソースを監視する興味深い方法になります。このパートでは、この考え方を探っていきます。まず、次の指示に従ってください。

`stocksim.py` というプログラムは、株価データをシミュレートするプログラムです。出力として、このプログラムはリアルタイムデータを `stocklog.csv` というファイルに常に書き込みます。別のコマンドウィンドウで、`` ディレクトリに移動してこのプログラムを実行します。

```bash
$ python3 stocksim.py
```

Windowsの場合は、`stocksim.py` プログラムを見つけてダブルクリックして実行します。これで、このプログラムは忘れておいてください（ただ実行させておきます）。別のウィンドウを使って、シミュレータによって書き込まれている `stocklog.csv` ファイルを見てみましょう。数秒ごとに新しいテキスト行がファイルに追加されているはずです。再び、このプログラムはバックグラウンドで実行させておいてください。数時間実行されます（心配する必要はありません）。

上記のプログラムが実行されたら、ファイルを開き、末尾まで移動して、新しい出力を監視するための小さなプログラムを書きましょう。`follow.py` というファイルを作成し、次のコードを入れます。

```python
# follow.py
import os
import time

f = open('stocklog.csv')
f.seek(0, os.SEEK_END)   # ファイル末尾から0バイト分移動してファイルポインタを移動させる

while True:
    line = f.readline()
    if line == '':
        time.sleep(0.1)   # 少し待ってから再試行
        continue
    fields = line.split(',')
    name = fields[0].strip('"')
    price = float(fields[1])
    change = float(fields[4])
    if change < 0:
        print(f'{name:>10s} {price:>10.2f} {change:>10.2f}')
```

このプログラムを実行すると、リアルタイムの株価情報が表示されます。このコードは、裏では、ログファイルを監視するために使用されるUnixの `tail -f` コマンドに似ています。

注：この例では、`readline()` メソッドの使用は、通常のファイルからの行の読み取り方法とは少し異なります（通常は `for` ループを使います）。ただし、この場合、ファイルの末尾を繰り返し調べて、新しいデータが追加されたかどうかを確認するために使用しています（`readline()` は新しいデータまたは空の文字列を返します）。
