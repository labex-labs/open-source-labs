# Создание декоратора класса для валидации

На предыдущем этапе наша реализация работала, но была избыточность. Мы должны были указать и кортеж `_fields`, и атрибуты-дескрипторы. Это не очень эффективно, и мы можем улучшить ситуацию. В Python декораторы классов - это мощный инструмент, который может помочь нам упростить этот процесс. Декоратор класса - это функция, которая принимает класс в качестве аргумента, модифицирует его каким-то образом и затем возвращает модифицированный класс. Используя декоратор класса, мы можем автоматически извлекать информацию о полях из дескрипторов, что сделает наш код чище и более поддерживаемым.

Давайте создадим декоратор класса для упрощения нашего кода. Вот шаги, которые вам нужно выполнить:

1. Сначала откройте файл `structure.py`. Вы можете использовать следующую команду в терминале:

```bash
code ~/project/structure.py
```

Эта команда откроет файл `structure.py` в вашем редакторе кода.

2. Затем добавьте следующий код в начало файла `structure.py` сразу после любых инструкций импорта. Этот код определяет наш декоратор класса:

```python
from validate import Validator

def validate_attributes(cls):
    """
    Class decorator that extracts Validator instances
    and builds the _fields list automatically
    """
    validators = []
    for name, val in vars(cls).items():
        if isinstance(val, Validator):
            validators.append(val)

    # Set _fields based on validator names
    cls._fields = [val.name for val in validators]

    # Create initialization method
    cls.create_init()

    return cls
```

Разберем, что делает этот декоратор:

- Сначала он создает пустой список с именем `validators`. Затем он проходит по всем атрибутам класса с помощью `vars(cls).items()`. Если атрибут является экземпляром класса `Validator`, он добавляет этот атрибут в список `validators`.
- Затем он устанавливает атрибут `_fields` класса. Он создает список имен из валидаторов в списке `validators` и присваивает его `cls._fields`.
- Наконец, он вызывает метод `create_init()` класса для генерации метода `__init__`, а затем возвращает модифицированный класс.

3. После добавления кода сохраните файл `structure.py`. Сохранение файла гарантирует, что ваши изменения будут сохранены.

4. Теперь нам нужно изменить файл `stock.py`, чтобы использовать этот новый декоратор. Откройте файл `stock.py` с помощью следующей команды:

```bash
code ~/project/stock.py
```

5. Обновите файл `stock.py`, чтобы использовать декоратор `validate_attributes`. Замените существующий код следующим:

```python
# stock.py

from structure import Structure, validate_attributes
from validate import String, PositiveInteger, PositiveFloat

@validate_attributes
class Stock(Structure):
    name = String()
    shares = PositiveInteger()
    price = PositiveFloat()

    @property
    def cost(self):
        return self.shares * self.price

    def sell(self, nshares):
        self.shares -= nshares
```

Обратите внимание на изменения, которые мы внесли:

- Мы добавили декоратор `@validate_attributes` сразу над определением класса `Stock`. Это сообщает Python применить декоратор `validate_attributes` к классу `Stock`.
- Мы удалили явное объявление `_fields`, так как декоратор будет обрабатывать его автоматически.
- Мы также удалили вызов `Stock.create_init()`, так как декоратор занимается созданием метода `__init__`.

Как результат, класс теперь проще и чище. Декоратор заботится обо всех деталях, которые мы раньше обрабатывали вручную.

6. После внесения этих изменений нам нужно убедиться, что все по-прежнему работает как ожидается. Запустите тесты еще раз с помощью следующих команд:

```bash
cd ~/project
python3 teststock.py
```

Если все работает правильно, вы должны увидеть следующий вывод:

```
.........
----------------------------------------------------------------------
Ran 9 tests in 0.001s

OK
```

Этот вывод указывает, что все тесты успешно пройдены.

Давайте также протестируем наш класс `Stock` интерактивно. Запустите следующую команду в терминале:

```bash
cd ~/project
python3 -c "from stock import Stock; s = Stock('GOOG', 100, 490.1); print(s); print(f'Cost: {s.cost}')"
```

Вы должны увидеть следующий вывод:

```
Stock('GOOG', 100, 490.1)
Cost: 49010.0
```

Отлично! Вы успешно реализовали декоратор класса, который упрощает наш код, автоматически обрабатывая объявление полей и инициализацию. Это делает наш код более эффективным и легким в поддержке.
