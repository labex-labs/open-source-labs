# Python でのメインモジュールの理解

Python では、スクリプトを直接実行すると、それが「メイン」モジュールとして機能します。Python には `__name__` という特別な変数があります。ファイルが直接実行されると、Python は `__name__` の値を `"__main__"` に設定します。これは、ファイルがモジュールとしてインポートされる場合とは異なります。

この機能は非常に便利です。なぜなら、ファイルが直接実行されるか、インポートされるかに応じて異なる動作をするコードを書くことができるからです。たとえば、あるコードをスクリプトとしてファイルを実行したときにのみ実行し、他のスクリプトによってインポートされたときには実行しないようにしたい場合があります。

## pcost.py をメインモジュールパターンを利用するように変更する

このパターンを利用するために、`pcost.py` プログラムを変更しましょう。

1. まず、エディタで `pcost.py` ファイルを開く必要があります。以下のコマンドを使用してプロジェクトディレクトリに移動し、ファイルが存在しない場合は作成することができます。

```bash
cd ~/project
touch pcost.py
```

`cd` コマンドは現在のディレクトリをホームディレクトリ内の `project` ディレクトリに変更します。`touch` コマンドは `pcost.py` という名前の新しいファイルが存在しない場合に作成します。

2. 次に、`pcost.py` ファイルを以下のように変更します。

```python
# pcost.py

def portfolio_cost(filename):
    total_cost = 0.0

    with open(filename, 'r') as f:
        for line in f:
            fields = line.split()
            try:
                nshares = int(fields[1])
                price = float(fields[2])
                total_cost += nshares * price
            except (ValueError, IndexError):
                print(f"Couldn't parse: {line}")

    return total_cost

# このコードはファイルがスクリプトとして実行されたときにのみ実行されます
if __name__ == "__main__":
    total = portfolio_cost('portfolio.dat')
    print(total)
```

主な変更点は、末尾のコードを `if __name__ == "__main__":` の条件文で囲んだことです。これは、このブロック内のコードがファイルがスクリプトとして直接実行されたときにのみ実行され、モジュールとしてインポートされたときには実行されないことを意味します。

3. これらの変更を加えた後、ファイルを保存してエディタを終了します。

## 変更後のモジュールのテスト

では、変更後のモジュールを 2 つの異なる方法でテストし、その動作を確認しましょう。

1. まず、以下のコマンドを使用してプログラムをスクリプトとして直接実行します。

```bash
python3 pcost.py
```

以前と同じように、出力として `44671.15` が表示されるはずです。これは、スクリプトを直接実行すると、`__name__` 変数が `"__main__"` に設定されるため、`if __name__ == "__main__":` ブロック内のコードが実行されるからです。

2. 次に、再び Python インタープリターを起動し、モジュールをインポートします。

```bash
python3
```

```python
import pcost
```

今回は何も出力が表示されません。モジュールをインポートすると、`__name__` 変数は `"pcost"`（モジュール名）に設定され、`"__main__"` ではなくなります。したがって、`if __name__ == "__main__":` ブロック内のコードは実行されません。

3. `portfolio_cost` 関数がまだ機能していることを確認するには、以下のように呼び出すことができます。

```python
pcost.portfolio_cost('portfolio.dat')
```

この関数は `44671.15` を返すはずで、これは関数が正常に動作していることを意味します。

4. 最後に、以下のコマンドを使用して Python インタープリターを終了します。

```python
exit()
```

このパターンは、インポート可能なモジュールとしても、スタンドアロンのスクリプトとしても使用できる Python ファイルを作成する際に非常に便利です。`if __name__ == "__main__":` ブロック内のコードは、ファイルが直接実行されたときにのみ実行され、モジュールとしてインポートされたときには実行されません。
