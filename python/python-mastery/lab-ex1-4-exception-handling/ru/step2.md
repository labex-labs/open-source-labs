# Добавление обработки ошибок

При работе с реальными данными очень часто встречаются несоответствия или ошибки. Например, данные могут иметь пропущенные значения, неправильный формат или другие проблемы. Python предлагает механизмы обработки исключений для элегантного решения таких ситуаций. Обработка исключений позволяет программе продолжать работу даже при возникновении ошибки, вместо того чтобы аварийно завершиться.

## Понимание проблемы

Рассмотрим файл `portfolio3.dat`. Этот файл содержит некоторые данные о портфеле, такие как символ акции, количество акций и цена за одну акцию. Чтобы просмотреть содержимое этого файла, можно использовать следующую команду:

```bash
cat /home/labex/project/portfolio3.dat
```

При выполнении этой команды вы заметите, что в некоторых строках файла вместо чисел для количества акций используются дефисы (`-`). Вот пример того, что вы можете увидеть:

```
AA 100 32.20
IBM 50 91.10
C - 53.08
...
```

Если мы попытаемся запустить текущий код на этом файле, он аварийно завершится. Причина в том, что наш код предполагает преобразование количества акций в целое число, но он не может преобразовать дефис (`-`) в целое число. Попробуем запустить код и посмотрим, что произойдет:

```bash
python3 -c "import sys; sys.path.append('/home/labex/project'); from pcost import portfolio_cost; print(portfolio_cost('/home/labex/project/portfolio3.dat'))"
```

Вы увидите сообщение об ошибке следующего вида:

```
ValueError: invalid literal for int() with base 10: '-'
```

Эта ошибка возникает, потому что Python не может преобразовать символ `-` в целое число при попытке выполнить `int(fields[1])`.

## Введение в обработку исключений

В Python обработка исключений использует блоки `try` и `except`. Блок `try` содержит код, который может вызвать исключение. Исключение - это ошибка, которая возникает во время выполнения программы. Блок `except` содержит код, который будет выполнен, если в блоке `try` возникнет исключение.

Вот пример того, как работают блоки `try` и `except`:

```python
try:
    # Code that might raise an exception
    result = risky_operation()
except ExceptionType as e:
    # Code to handle the exception
    print(f"An error occurred: {e}")
```

Когда Python выполняет код в блоке `try`, если возникает исключение, выполнение сразу переходит в соответствующий блок `except`. `ExceptionType` в блоке `except` указывает тип исключения, которое мы хотим обработать. Переменная `e` содержит информацию об исключении, например, сообщение об ошибке.

## Модификация функции с использованием обработки исключений

Обновим файл `pcost.py`, чтобы обработать ошибки в данных. Мы будем использовать блоки `try` и `except` для пропуска строк с некорректными данными и вывода предупреждающего сообщения.

```python
def portfolio_cost(filename):
    """
    Computes the total cost (shares*price) of a portfolio file
    Handles lines with bad data by skipping them and showing a warning.

    Args:
        filename: The name of the portfolio file

    Returns:
        The total cost of the portfolio as a float
    """
    total_cost = 0.0

    # Open the file and read through each line
    with open(filename, 'r') as f:
        for line in f:
            fields = line.split()
            try:
                # Extract the data (symbol, shares, price)
                shares = int(fields[1])
                price = float(fields[2])
                # Add the cost to our running total
                total_cost += shares * price
            except ValueError as e:
                # Print a warning for lines that can't be parsed
                print(f"Couldn't parse: '{line}'")
                print(f"Reason: {e}")

    return total_cost

# Call the function with the portfolio3.dat file
if __name__ == '__main__':
    cost = portfolio_cost('/home/labex/project/portfolio3.dat')
    print(cost)
```

В этом обновленном коде мы сначала открываем файл и читаем его построчно. Для каждой строки мы разбиваем ее на поля. Затем мы пытаемся преобразовать количество акций в целое число и цену в число с плавающей точкой. Если это преобразование завершается неудачно (т.е. возникает исключение `ValueError`), мы выводим предупреждающее сообщение и пропускаем эту строку. В противном случае мы вычисляем стоимость акций и добавляем ее к общей стоимости.

## Тестирование обновленной функции

Теперь запустим обновленную программу с проблемным файлом. Сначала нужно перейти в директорию проекта, а затем можно запустить скрипт Python.

```bash
cd /home/labex/project
python3 pcost.py
```

Вы должны увидеть вывод следующего вида:

```
Couldn't parse: 'C - 53.08
'
Reason: invalid literal for int() with base 10: '-'
Couldn't parse: 'DIS - 34.20
'
Reason: invalid literal for int() with base 10: '-'
44671.15
```

Теперь программа делает следующее:

1. Она пытается обработать каждую строку файла.
2. Если строка содержит недопустимые данные, она перехватывает исключение `ValueError`.
3. Она выводит полезное сообщение о проблеме.
4. Она продолжает обработку остальной части файла.
5. Она возвращает общую стоимость на основе допустимых строк.

Такой подход делает нашу программу гораздо более устойчивой при работе с неидеальными данными. Она может элегантно обрабатывать ошибки и по-прежнему предоставлять полезные результаты.
