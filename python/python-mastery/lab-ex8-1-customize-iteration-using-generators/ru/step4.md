# Мониторинг потока данных

Генераторы также могут быть полезным способом просто генерировать поток данных. В этом разделе мы будем изучать эту идею, написав генератор для просмотра файла журнала. Для начала следуйте инструкциям ниже внимательно.

Программа `stocksim.py` - это программа, которая симулирует данные о рынке ценных бумаг. В качестве вывода программа постоянно записывает в файл `stocklog.csv` актуальные данные. В командной строке (не в IDLE) перейдите в директорию и запустите эту программу:

    % python3 stocksim.py

Если вы используете Windows, просто найдите программу `stocksim.py` и дважды кликните по ней, чтобы запустить. Теперь не обращайте внимания на эту программу (просто пусть она работает). Еще раз, просто пусть эта программа работает в фоновом режиме - она будет работать несколько часов (вам не нужно беспокоиться о ней).

Как только вышеуказанная программа запущена, давайте напишем небольшую программу, которая откроет файл, переместит указатель в конец и будет следить за новым выводом. Создайте файл `follow.py` и вставьте в него этот код:

```python
# follow.py
import os
import time
f = open('stocklog.csv')
f.seek(0, os.SEEK_END)   # Move file pointer 0 bytes from end of file

while True:
    line = f.readline()
    if line == '':
        time.sleep(0.1)   # Sleep briefly and retry
        continue
    fields = line.split(',')
    name = fields[0].strip('"')
    price = float(fields[1])
    change = float(fields[4])
    if change < 0:
        print('%10s %10.2f %10.2f' % (name, price, change))
```

Если вы запустите программу, вы увидите реальный тикер акций. Под капотом этот код похож на команду Unix `tail -f`, которая используется для просмотра файла журнала.

**Примечание:** Использование метода `readline()` в этом примере несколько необычно, так как это не обычный способ чтения строк из файла (обычно вы бы просто использовали цикл `for`). Однако в этом случае мы используем его для повторного проверки конца файла, чтобы понять, были ли добавлены новые данные (`readline()` либо вернет новые данные, либо пустую строку).

Если вы внимательно изучите код, то в первой части кода производятся строки данных, а в конце цикла `while` эти данные обрабатываются. Главная особенность функций-генераторов заключается в том, что вы можете перенести весь код по производству данных в переиспользуемую функцию.

Измените код так, чтобы чтение файла выполнялось с помощью генераторной функции `follow(filename)`. Сделайте так, чтобы работал следующий код:

```python
>>> for line in follow('stocklog.csv'):
          print(line, end='')

... Здесь должны появиться строки вывода...
```

Измените код тикера акций так, чтобы он выглядел так:

```python
for line in follow('stocklog.csv'):
    fields = line.split(',')
    name = fields[0].strip('"')
    price = float(fields[1])
    change = float(fields[4])
    if change < 0:
        print('%10s %10.2f %10.2f' % (name, price, change))
```

**Обсуждение**

Здесь что-то очень мощное произошло. Вы перенесли интересный паттерн итерации (чтение строк в конце файла) в свою небольшую функцию. Теперь функция `follow()` - это совершенно универсальный инструмент, который вы можете использовать в любом проекте. Например, вы можете использовать его для просмотра журналов сервера, отладочных журналов и других подобных источников данных. Это довольно круто.
