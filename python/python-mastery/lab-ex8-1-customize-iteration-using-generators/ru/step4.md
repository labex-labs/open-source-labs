# Создание генератора для потоковых данных

В программировании генераторы являются мощным инструментом, особенно при решении реальных задач, таких как мониторинг потокового источника данных. В этом разделе мы узнаем, как применить наши знания о генераторах в такой практической ситуации. Мы создадим генератор, который будет отслеживать лог - файл и выдавать новые строки по мере их добавления в файл.

## Настройка источника данных

Перед тем как начать создавать генератор, нам нужно настроить источник данных. В этом случае мы будем использовать программу - симулятор, которая генерирует данные о фондовом рынке.

Сначала вам нужно открыть новый терминал в WebIDE. Именно здесь вы будете запускать команды для запуска симуляции.

После открытия терминала вы запустите программу симуляции фондового рынка. Вот команды, которые вам нужно ввести:

```bash
cd ~/project
python3 stocksim.py
```

Первая команда `cd ~/project` изменяет текущую директорию на директорию `project` в вашей домашней директории. Вторая команда `python3 stocksim.py` запускает программу симуляции фондового рынка. Эта программа будет генерировать данные о фондовом рынке и записывать их в файл с именем `stocklog.csv` в текущей директории. Дайте этой программе работать в фоновом режиме, пока мы работаем над кодом мониторинга.

## Создание простого монитора файла

Теперь, когда у нас настроен источник данных, давайте создадим программу, которая будет отслеживать файл `stocklog.csv`. Эта программа будет отображать любые отрицательные изменения цен.

1. Сначала создайте новый файл с именем `follow.py` в WebIDE. Для этого вам нужно изменить директорию на директорию `project` с помощью следующей команды в терминале:

```bash
cd ~/project
```

2. Затем добавьте следующий код в файл `follow.py`. Этот код открывает файл `stocklog.csv`, перемещает указатель файла в конец файла, а затем постоянно проверяет наличие новых строк. Если найдена новая строка и она представляет собой отрицательное изменение цены, он выводит название акции, цену и изменение.

```python
# follow.py
import os
import time

f = open('stocklog.csv')
f.seek(0, os.SEEK_END)   # Move file pointer 0 bytes from end of file

while True:
    line = f.readline()
    if line == '':
        time.sleep(0.1)   # Sleep briefly and retry
        continue
    fields = line.split(',')
    name = fields[0].strip('"')
    price = float(fields[1])
    change = float(fields[4])
    if change < 0:
        print('%10s %10.2f %10.2f' % (name, price, change))
```

3. После добавления кода сохраните файл. Затем запустите программу с помощью следующей команды в терминале:

```bash
python3 follow.py
```

Вы должны увидеть вывод, показывающий акции с отрицательными изменениями цен. Он может выглядеть примерно так:

```
      AAPL     148.24      -1.76
      GOOG    2498.45      -1.55
```

Если вы хотите остановить программу, нажмите `Ctrl+C` в терминале.

## Преобразование в функцию - генератор

Хотя предыдущий код работает, мы можем сделать его более переиспользуемым и модульным, преобразовав его в функцию - генератор. Функция - генератор - это особый тип функции, которая может быть приостановлена и возобновлена, и которая выдаёт значения по одному.

1. Откройте снова файл `follow.py` и измените его так, чтобы он использовал функцию - генератор. Вот обновлённый код:

```python
# follow.py
import os
import time

def follow(filename):
    """
    Generator function that yields new lines in a file as they are added.
    Similar to the 'tail -f' Unix command.
    """
    f = open(filename)
    f.seek(0, os.SEEK_END)   # Move to the end of the file

    while True:
        line = f.readline()
        if line == '':
            time.sleep(0.1)   # Sleep briefly and retry
            continue
        yield line

# Example usage - monitor stocks with negative price changes
if __name__ == '__main__':
    for line in follow('stocklog.csv'):
        fields = line.split(',')
        name = fields[0].strip('"')
        price = float(fields[1])
        change = float(fields[4])
        if change < 0:
            print('%10s %10.2f %10.2f' % (name, price, change))
```

Функция `follow` теперь является функцией - генератором. Она открывает файл, перемещается в конец и затем постоянно проверяет наличие новых строк. Когда найдена новая строка, она выдаёт эту строку.

2. Сохраните файл и запустите его снова с помощью команды:

```bash
python3 follow.py
```

Вывод должен быть таким же, как и раньше. Но теперь логика мониторинга файла аккуратно инкапсулирована в функции - генераторе `follow`. Это означает, что мы можем переиспользовать эту функцию в других программах, которые нуждаются в мониторинге файла.

## Понимание мощности генераторов

Преобразовав наш код для чтения файла в функцию - генератор, мы сделали его намного более гибким и переиспользуемым. Функция `follow()` может быть использована в любой программе, которая нуждается в мониторинге файла, а не только для данных о акциях.

Например, вы можете использовать её для мониторинга журналов сервера, журналов приложений или любого другого файла, который обновляется со временем. Это показывает, как генераторы являются отличным способом обработки потоковых источников данных в чистый и модульный способ.
