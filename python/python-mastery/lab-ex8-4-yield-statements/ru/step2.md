# Обработка исключений в генераторах

В этом шаге мы научимся обрабатывать исключения в генераторах и корутинах. Но сначала разберемся, что такое исключения. Исключение - это событие, которое происходит во время выполнения программы и нарушает нормальный поток выполнения инструкций программы. В Python мы можем использовать метод `throw()` для обработки исключений в генераторах и корутинах.

## Понимание корутин

Корутина - это особый тип генератора. В отличие от обычных генераторов, которые в основном выдают значения, корутины могут как потреблять значения (с помощью метода `send()`), так и выдавать их. Файл `cofollow.py` содержит простую реализацию корутины.

Откройте файл `cofollow.py` в редакторе WebIDE. Вот код, который находится внутри:

```python
def consumer(func):
    def start(*args,**kwargs):
        c = func(*args,**kwargs)
        next(c)
        return c
    return start

@consumer
def printer():
    while True:
        item = yield
        print(item)
```

Теперь разберем этот код. `consumer` - это декоратор. Декоратор - это функция, которая принимает другую функцию в качестве аргумента, добавляет к ней некоторую функциональность и затем возвращает модифицированную функцию. В данном случае декоратор `consumer` автоматически перемещает генератор к его первому оператору `yield`. Это важно, так как делает генератор готовым к приему значений.

Корутина `printer()` определена с использованием декоратора `@consumer`. Внутри функции `printer()` есть бесконечный цикл `while`. Оператор `item = yield` - это то, где происходит магия. Он приостанавливает выполнение корутины и ждет получения значения. Когда значение отправляется в корутину, она возобновляет выполнение и выводит полученное значение.

## Добавление обработки исключений в корутину

Теперь мы модифицируем корутину `printer()` для обработки исключений. Обновим функцию `printer()` в файле `cofollow.py` следующим образом:

```python
@consumer
def printer():
    while True:
        try:
            item = yield
            print(item)
        except Exception as e:
            print('ERROR: %r' % e)
```

Блок `try` содержит код, который может вызвать исключение. В нашем случае это код, который получает и выводит значение. Если в блоке `try` возникает исключение, выполнение переходит в блок `except`. Блок `except` перехватывает исключение и выводит сообщение об ошибке. После внесения этих изменений сохраните файл.

## Эксперименты с обработкой исключений в корутинах

Начнем экспериментировать с выбрасыванием исключений в корутину. Откройте терминал и запустите интерпретатор Python с помощью следующих команд:

```bash
cd ~/project
python3
```

### Эксперимент 1: Базовое использование корутины

```python
>>> from cofollow import printer
>>> p = printer()
>>> p.send('hello')  # Send a value to the coroutine
hello
>>> p.send(42)  # Send another value
42
```

Здесь мы сначала импортируем корутину `printer` из модуля `cofollow`. Затем создаем экземпляр корутины `printer` с именем `p`. Мы используем метод `send()` для отправки значений в корутину. Как вы видите, корутина обрабатывает отправленные нам значения без проблем.

### Эксперимент 2: Выбрасывание исключения в корутину

```python
>>> p.throw(ValueError('It failed'))  # Throw an exception into the coroutine
ERROR: ValueError('It failed')
```

В этом эксперименте мы используем метод `throw()` для внедрения исключения `ValueError` в корутину. Блок `try - except` в корутине `printer()` перехватывает исключение и выводит сообщение об ошибке. Это показывает, что наша обработка исключений работает как ожидалось.

### Эксперимент 3: Выбрасывание реального исключения в корутину

```python
>>> try:
...     int('n/a')  # This will raise a ValueError
... except ValueError as e:
...     p.throw(e)  # Throw the caught exception into the coroutine
...
ERROR: ValueError("invalid literal for int() with base 10: 'n/a'")
```

Здесь мы сначала пытаемся преобразовать строку `'n/a'` в целое число, что вызывает исключение `ValueError`. Мы перехватываем это исключение и затем используем метод `throw()` для передачи его в корутину. Корутина перехватывает исключение и выводит сообщение об ошибке.

### Эксперимент 4: Проверка, что корутина продолжает работу

```python
>>> p.send('still working')  # The coroutine continues to run after handling exceptions
still working
```

После обработки исключений мы отправляем еще одно значение в корутину с помощью метода `send()`. Корутина все еще активна и может обработать новое значение. Это показывает, что наша корутина может продолжать работу даже после возникновения ошибок.

## Основные выводы

1. Генераторы и корутины могут обрабатывать исключения в точке оператора `yield`. Это означает, что мы можем перехватывать и обрабатывать ошибки, которые возникают, когда корутина ожидает или обрабатывает значение.
2. Метод `throw()` позволяет внедрять исключения в генератор или корутину. Это полезно для тестирования и обработки ошибок, которые возникают вне корутины.
3. Правильная обработка исключений в генераторах позволяет создавать надежные, устойчивые к ошибкам генераторы, которые могут продолжать работу даже при возникновении ошибок. Это делает ваш код более надежным и легким в поддержке.

Для выхода из интерпретатора Python вы можете ввести `exit()` или нажать `Ctrl + D`.
