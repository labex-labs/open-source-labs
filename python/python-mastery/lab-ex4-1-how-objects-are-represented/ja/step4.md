# クラスとインスタンスの関係の理解

ここでは、Python におけるクラスとインスタンスの関係、およびメソッドの検索方法について探っていきます。これは、オブジェクトを操作する際に Python がメソッドや属性をどのように見つけて使用するかを理解する上で重要な概念です。

まず、インスタンスが属するクラスを確認しましょう。インスタンスのクラスを知ることは、Python がそのインスタンスに関連するメソッドや属性をどこで探すかを知るために重要です。

```python
>>> goog.__class__
<class '__main__.SimpleStock'>
>>> ibm.__class__
<class '__main__.SimpleStock'>
```

両方のインスタンスは `SimpleStock` クラスへの参照を持っています。この参照は、Python がメソッドを検索する際に使用するポインタのようなものです。インスタンスに対してメソッドを呼び出すと、Python はこの参照を使って適切なメソッド定義を見つけます。

インスタンスに対してメソッドを呼び出すと、Python は以下の手順に従います。

1. インスタンスの `__dict__` 内で属性を探します。インスタンスの `__dict__` は、すべてのインスタンス固有の属性が格納される領域のようなものです。
2. 見つからない場合は、クラスの `__dict__` をチェックします。クラスの `__dict__` には、そのクラスのすべてのインスタンスに共通の属性やメソッドが格納されています。
3. クラス内で見つかった場合は、その属性を返します。

これを実際に見てみましょう。まず、`cost` メソッドがインスタンスの辞書に存在しないことを確認します。この手順により、`cost` メソッドは各インスタンスに固有のものではなく、クラスレベルで定義されていることがわかります。

```python
>>> 'cost' in goog.__dict__
False
>>> 'cost' in ibm.__dict__
False
```

では、`cost` メソッドはどこから来ているのでしょうか？クラスをチェックしてみましょう。クラスの `__dict__` を見ることで、`cost` メソッドがどこで定義されているかを知ることができます。

```python
>>> SimpleStock.__dict__['cost']
<function SimpleStock.cost at 0x7f...>
```

このメソッドはインスタンスではなく、クラスに定義されています。`goog.cost()` を呼び出すと、Python は `goog.__dict__` 内に `cost` を見つけられないため、`SimpleStock.__dict__` を見てそこで見つけます。

実際に、インスタンスを最初の引数（これが `self` になります）として渡して、クラスの辞書から直接メソッドを呼び出すことができます。これは、通常の `instance.method()` 構文を使用するときに Python が内部的にメソッドを呼び出す方法を示しています。

```python
>>> SimpleStock.__dict__['cost'](goog)
49010.0
>>> SimpleStock.__dict__['cost'](ibm)
4561.5
```

これが、`goog.cost()` を呼び出したときに Python が内部で行っていることです。

では、クラス属性を追加してみましょう。クラス属性はすべてのインスタンスによって共有されます。これは、クラスのすべてのインスタンスがこの属性にアクセスでき、それがクラスレベルで 1 回だけ格納されることを意味します。

```python
>>> SimpleStock.exchange = 'NASDAQ'
>>> goog.exchange
'NASDAQ'
>>> ibm.exchange
'NASDAQ'
```

両方のインスタンスは `exchange` 属性にアクセスできますが、それは個々の辞書には格納されていません。インスタンスとクラスの辞書をチェックしてこれを確認しましょう。

```python
>>> 'exchange' in goog.__dict__
False
>>> 'exchange' in SimpleStock.__dict__
True
>>> SimpleStock.__dict__['exchange']
'NASDAQ'
```

これは以下のことを示しています。

1. クラス属性はすべてのインスタンスによって共有されます。すべてのインスタンスは、自分自身のコピーを持たずに同じクラス属性にアクセスできます。
2. Python はまずインスタンスの辞書をチェックし、次にクラスの辞書をチェックします。これは、インスタンスに対して属性にアクセスしようとするときに Python が属性を探す順序です。
3. クラスは、共有データと振る舞い（メソッド）のリポジトリとして機能します。クラスは、すべてのインスタンスが使用できる共通の属性とメソッドを格納しています。

同じ名前のインスタンス属性を変更すると、クラス属性が隠されます。これは、そのインスタンスに対して属性にアクセスするときに、Python がクラスレベルの値ではなくインスタンス固有の値を使用することを意味します。

```python
>>> ibm.exchange = 'NYSE'
>>> ibm.exchange
'NYSE'
>>> goog.exchange  # 依然としてクラス属性を使用
'NASDAQ'
>>> ibm.__dict__['exchange']
'NYSE'
```

これで、`ibm` はクラス属性を隠す独自の `exchange` 属性を持つようになり、`goog` は依然としてクラス属性を使用しています。
