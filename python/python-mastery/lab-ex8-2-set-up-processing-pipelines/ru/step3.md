# Создание более сложного конвейера обработки данных

Теперь мы возьмем наш конвейер обработки данных на новый уровень, добавив фильтрацию и улучшив представление данных. Это облегчит анализ и понимание информации, с которой мы работаем. Мы внесем изменения в наш скрипт `ticker.py`. Фильтрация данных поможет нам сосредоточиться на конкретной информации, которая нас интересует, а представление ее в хорошо отформатированной таблице сделает ее более читаемой.

## Обновление файла ticker.py

1. Сначала откройте файл `ticker.py` в WebIDE. WebIDE - это инструмент, который позволяет писать и редактировать код прямо в браузере. Он предоставляет удобную среду для внесения изменений в ваши Python - скрипты.

2. Затем нам нужно заменить блок `if __name__ == '__main__':` в файле `ticker.py` следующим кодом. Этот блок кода является точкой входа в наш скрипт, и, заменив его, мы изменим, как скрипт обрабатывает и отображает данные.

```python
if __name__ == '__main__':
    from follow import follow
    import csv
    from tableformat import create_formatter, print_table

    formatter = create_formatter('text')

    lines = follow('stocklog.csv')
    rows = csv.reader(lines)
    records = (Ticker.from_row(row) for row in rows)
    negative = (rec for rec in records if rec.change < 0)
    print_table(negative, ['name', 'price', 'change'], formatter)
```

3. После внесения этих изменений сохраните файл. Вы можете сделать это, нажав `Ctrl+S` на клавиатуре или выбрав "File" → "Save" в меню. Сохранение файла гарантирует, что ваши изменения будут сохранены и можно будет запустить код позже.

## Понимание усовершенствованного конвейера

Рассмотрим более подробно, что делает этот усовершенствованный конвейер. Понимание каждого шага поможет вам увидеть, как разные части кода работают вместе для обработки и отображения данных.

1. Мы начинаем с импорта функций `create_formatter` и `print_table` из модуля `tableformat`. Этот модуль уже настроен для вас, и он предоставляет функции, которые помогают нам форматировать и выводить данные в красивой таблице.

2. Затем мы создаем текстовый форматер с помощью `create_formatter('text')`. Этот форматер будет использоваться для форматирования данных таким образом, чтобы они были легко читаемыми.

3. Теперь разберем конвейер пошагово:
   - `follow('stocklog.csv')` - это функция, которая генерирует строки из файла `stocklog.csv`. Она постоянно отслеживает файл на предмет появления новых данных и предоставляет строки по одной.
   - `csv.reader(lines)` принимает строки, сгенерированные функцией `follow`, и разбирает их на строки данных. Это необходимо, так как данные в файле CSV находятся в текстовом формате, и нам нужно преобразовать их в структурированный формат, с которым мы можем работать.
   - `(Ticker.from_row(row) for row in rows)` - это выражение - генератор, которое преобразует каждую строку данных в объект `Ticker`. Объект `Ticker` представляет акцию и содержит информацию, такую как название акции, цена и изменение цены.
   - `(rec for rec in records if rec.change < 0)` - это еще одно выражение - генератор, которое фильтрует объекты `Ticker`. Оно сохраняет только те объекты, у которых изменение цены акции отрицательное. Это позволяет нам сосредоточиться на акциях, чья цена снизилась.
   - `print_table(negative, ['name', 'price', 'change'], formatter)` принимает отфильтрованные объекты `Ticker` и форматирует их в таблицу с помощью форматера, который мы создали ранее. Затем он выводит таблицу в консоль.

Этот конвейер демонстрирует мощь генераторов. Вместо того чтобы загружать все данные из файла в память сразу, мы объединяем несколько операций (чтение, разбор, преобразование, фильтрация) и обрабатываем данные по одному элементу за раз. Это экономит память и делает код более эффективным.

## Запуск усовершенствованного конвейера

Запустим обновленный код, чтобы увидеть результаты.

1. Сначала убедитесь, что вы находитесь в директории проекта в терминале. Если вы еще не там, вы можете перейти в нее с помощью следующей команды:

   ```bash
   cd /home/labex/project
   ```

2. Когда вы находитесь в директории проекта, запустите скрипт `ticker.py` с помощью следующей команды:

   ```bash
   python3 ticker.py
   ```

3. После запуска скрипта вы должны увидеть хорошо отформатированную таблицу в терминале. Эта таблица показывает только акции с отрицательным изменением цены.

   ```
          name      price     change
    ---------- ---------- ----------
             C      53.12      -0.21
           UTX      70.04      -0.19
           AXP      62.86      -0.18
           MMM      85.72      -0.22
           MCD      51.38      -0.03
           WMT      49.85      -0.23
            KO       51.6      -0.07
           AIG      71.39      -0.14
            PG      63.05      -0.02
            HD      37.76      -0.19
   ```

Если вы видите достаточно вывода и хотите остановить выполнение скрипта, вы можете нажать `Ctrl+C` на клавиатуре.

## Мощь конвейеров на основе генераторов

То, что мы создали здесь, представляет собой мощный конвейер обработки данных. Сводим его действия:

1. Он постоянно отслеживает файл `stocklog.csv` на предмет появления новых данных. Это означает, что по мере добавления новых данных в файл конвейер автоматически обработает их.
2. Он разбирает данные в формате CSV из файла в структурированные объекты `Ticker`. Это облегчает работу с данными и выполнение операций над ними.
3. Он фильтрует данные на основе определенного критерия, в данном случае - отрицательного изменения цены. Это позволяет нам сосредоточиться на акциях, которые теряют в цене.
4. Он форматирует и представляет отфильтрованные данные в читаемой таблице. Это облегчает анализ данных и вывод выводов.

Одно из ключевых преимуществ использования генераторов в этом конвейере - это минимальное использование памяти. Генераторы создают значения по запросу, что означает, что они не хранят все данные в памяти сразу. Это похоже на Unix - конвейеры, где каждый компонент обрабатывает данные и передает их следующему компоненту.

Вы можете думать о генераторах как о деталях Lego. Как вы можете собирать детали Lego вместе, чтобы создать разные конструкции, так вы можете комбинировать генераторы, чтобы создать мощные рабочие процессы обработки данных. Этот модульный подход позволяет создавать сложные системы из простых, повторно используемых компонентов.
