# 보다 복잡한 데이터 파이프라인 구축

이제 데이터 파이프라인을 다음 단계로 끌어올려 필터링을 추가하고 데이터 표현을 개선할 것입니다. 이렇게 하면 작업 중인 정보를 분석하고 이해하기가 더 쉬워집니다. `ticker.py` 스크립트를 변경할 것입니다. 데이터를 필터링하면 관심 있는 특정 정보에 집중하는 데 도움이 되며, 이를 잘 형식화된 표로 표시하면 가독성이 향상됩니다.

## ticker.py 파일 업데이트

1. 먼저 WebIDE 에서 `ticker.py` 파일을 엽니다. WebIDE 는 브라우저에서 직접 코드를 작성하고 편집할 수 있는 도구입니다. Python 스크립트를 변경하기 위한 편리한 환경을 제공합니다.

2. 다음으로, `ticker.py` 파일의 `if __name__ == '__main__':` 블록을 다음 코드로 바꿔야 합니다. 이 코드 블록은 스크립트의 진입점이며, 이를 대체하여 스크립트가 데이터를 처리하고 표시하는 방식을 변경합니다.

```python
if __name__ == '__main__':
    from follow import follow
    import csv
    from tableformat import create_formatter, print_table

    formatter = create_formatter('text')

    lines = follow('stocklog.csv')
    rows = csv.reader(lines)
    records = (Ticker.from_row(row) for row in rows)
    negative = (rec for rec in records if rec.change < 0)
    print_table(negative, ['name', 'price', 'change'], formatter)
```

3. 이러한 변경을 수행한 후 파일을 저장합니다. 키보드에서 `Ctrl+S`를 누르거나 메뉴에서 "File" → "Save"를 선택하여 이 작업을 수행할 수 있습니다. 파일을 저장하면 변경 사항이 유지되고 나중에 실행할 수 있습니다.

## 향상된 파이프라인 이해

이 향상된 파이프라인이 수행하는 작업을 자세히 살펴보겠습니다. 각 단계를 이해하면 코드의 서로 다른 부분이 어떻게 함께 작동하여 데이터를 처리하고 표시하는지 알 수 있습니다.

1. 먼저 `tableformat` 모듈에서 `create_formatter` 및 `print_table`을 가져오는 것으로 시작합니다. 이 모듈은 이미 설정되어 있으며 데이터를 멋진 표로 형식화하고 인쇄하는 데 도움이 되는 함수를 제공합니다.

2. 그런 다음 `create_formatter('text')`를 사용하여 텍스트 형식 지정자를 만듭니다. 이 형식 지정자는 데이터를 읽기 쉬운 방식으로 형식화하는 데 사용됩니다.

3. 이제 파이프라인을 단계별로 분석해 보겠습니다.
   - `follow('stocklog.csv')`는 `stocklog.csv` 파일에서 줄을 생성하는 함수입니다. 파일에서 새 데이터를 지속적으로 모니터링하고 줄을 하나씩 제공합니다.
   - `csv.reader(lines)`는 `follow`에서 생성된 줄을 가져와 행 데이터로 구문 분석합니다. CSV 파일의 데이터가 텍스트 형식이고 이를 작업할 수 있는 구조화된 형식으로 변환해야 하므로 필요합니다.
   - `(Ticker.from_row(row) for row in rows)`는 각 데이터 행을 `Ticker` 객체로 변환하는 제너레이터 표현식입니다. `Ticker` 객체는 주식을 나타내며 주식 이름, 가격 및 변동과 같은 정보를 포함합니다.
   - `(rec for rec in records if rec.change < 0)`는 `Ticker` 객체를 필터링하는 또 다른 제너레이터 표현식입니다. 주식의 가격 변동이 음수인 객체만 유지합니다. 이를 통해 가격이 하락한 주식에 집중할 수 있습니다.
   - `print_table(negative, ['name', 'price', 'change'], formatter)`는 필터링된 `Ticker` 객체를 가져와 앞에서 만든 형식 지정자를 사용하여 표로 형식화합니다. 그런 다음 표를 콘솔에 인쇄합니다.

이 파이프라인은 제너레이터의 강력함을 보여줍니다. 파일에서 모든 데이터를 한 번에 메모리에 로드하는 대신 여러 작업 (읽기, 구문 분석, 변환, 필터링) 을 함께 연결하고 데이터를 한 번에 하나씩 처리합니다. 이렇게 하면 메모리를 절약하고 코드를 더 효율적으로 만들 수 있습니다.

## 향상된 파이프라인 실행

업데이트된 코드를 실행하여 결과를 확인해 보겠습니다.

1. 먼저 터미널에서 프로젝트 디렉토리에 있는지 확인합니다. 아직 해당 디렉토리에 있지 않은 경우 다음 명령을 사용하여 이동할 수 있습니다.

   ```bash
   cd /home/labex/project
   ```

2. 프로젝트 디렉토리에 있으면 다음 명령을 사용하여 `ticker.py` 스크립트를 실행합니다.

   ```bash
   python3 ticker.py
   ```

3. 스크립트를 실행한 후 터미널에 잘 형식화된 표가 표시됩니다. 이 표에는 가격 변동이 음수인 주식만 표시됩니다.

   ```
          name      price     change
    ---------- ---------- ----------
             C      53.12      -0.21
           UTX      70.04      -0.19
           AXP      62.86      -0.18
           MMM      85.72      -0.22
           MCD      51.38      -0.03
           WMT      49.85      -0.23
            KO       51.6      -0.07
           AIG      71.39      -0.14
            PG      63.05      -0.02
            HD      37.76      -0.19
   ```

출력이 충분히 표시되었고 스크립트 실행을 중지하려는 경우 키보드에서 `Ctrl+C`를 누를 수 있습니다.

## 제너레이터 파이프라인의 강력함

여기에서 생성한 것은 강력한 데이터 처리 파이프라인입니다. 수행하는 작업을 요약해 보겠습니다.

1. `stocklog.csv` 파일에서 새 데이터를 지속적으로 모니터링합니다. 즉, 파일에 새 데이터가 추가되면 파이프라인이 자동으로 처리합니다.
2. 파일에서 CSV 데이터를 구조화된 `Ticker` 객체로 구문 분석합니다. 이렇게 하면 데이터를 더 쉽게 사용하고 작업을 수행할 수 있습니다.
3. 특정 기준, 이 경우 음수 가격 변동을 기반으로 데이터를 필터링합니다. 이를 통해 가치를 잃고 있는 주식에 집중할 수 있습니다.
4. 필터링된 데이터를 읽기 쉬운 표로 형식화하고 표시합니다. 이를 통해 데이터를 쉽게 분석하고 결론을 도출할 수 있습니다.

이 파이프라인에서 제너레이터를 사용하는 주요 장점 중 하나는 최소한의 메모리를 사용한다는 것입니다. 제너레이터는 필요에 따라 값을 생성하므로 모든 데이터를 한 번에 메모리에 저장하지 않습니다. 이는 각 구성 요소가 데이터를 처리하고 다음 구성 요소로 전달하는 Unix 파이프와 유사합니다.

제너레이터를 레고 블록으로 생각할 수 있습니다. 다양한 구조를 만들기 위해 레고 블록을 함께 쌓을 수 있는 것처럼 제너레이터를 결합하여 강력한 데이터 처리 워크플로를 만들 수 있습니다. 이 모듈식 접근 방식을 사용하면 간단하고 재사용 가능한 구성 요소에서 복잡한 시스템을 구축할 수 있습니다.
