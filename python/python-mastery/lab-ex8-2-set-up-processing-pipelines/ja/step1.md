# CSV データを使用した基本的なジェネレータパイプライン

このステップでは、ジェネレータ (generator) を使用して基本的な処理パイプラインを作成する方法を学びます。まずは、ジェネレータが何であるかを理解しましょう。ジェネレータは Python の特殊な種類のイテレータ (iterator) です。一度にすべてのデータをメモリにロードする通常のイテレータとは異なり、ジェネレータは必要に応じて値を生成します。これは大規模なデータストリームを扱う際に非常に有用で、メモリを節約します。ジェネレータは、データセット全体をメモリに格納する代わりに、必要なときに値を 1 つずつ生成します。

## ジェネレータの理解

ジェネレータは本質的にイテレータを返す関数です。このイテレータを反復処理すると、一連の値が生成されます。ジェネレータ関数の書き方は通常の関数に似ていますが、重要な違いがあります。通常の関数では `return` 文を使用しますが、ジェネレータ関数では `yield` 文を使用します。`yield` 文は独特な動作をします。関数を一時停止し、現在の状態を保存します。次の値が要求されると、関数は中断したところから再開します。これにより、ジェネレータは毎回最初から始める必要なく、値を段階的に生成することができます。

## follow() 関数の使用

先ほど作成した `follow()` 関数は、Unix の `tail -f` コマンドと同様の動作をします。`tail -f` コマンドはファイルの新しい内容を継続的に監視し、`follow()` 関数も同じです。では、これを使用して簡単な処理パイプラインを作成しましょう。

### ステップ 1: 新しいターミナルウィンドウを開く

まず、WebIDE で新しいターミナルウィンドウを開きます。`Terminal → New Terminal` から開くことができます。この新しいターミナルで Python コマンドを実行します。

### ステップ 2: Python インタラクティブシェルを起動する

新しいターミナルが開いたら、Python インタラクティブシェルを起動します。ターミナルに以下のコマンドを入力することで起動できます。

```bash
python3
```

Python インタラクティブシェルを使用すると、Python コードを 1 行ずつ実行し、すぐに結果を確認することができます。

### ステップ 3: `follow` 関数をインポートし、パイプラインを設定する

次に、`follow` 関数をインポートし、株式データを読み取る基本的なパイプラインを設定します。Python インタラクティブシェルで以下のコードを入力します。

```python
>>> from follow import follow
>>> import csv
>>> lines = follow('stocklog.csv')
>>> rows = csv.reader(lines)
>>> for row in rows:
...     print(row)
...
```

各行の動作は以下の通りです。

- `from follow import follow`: `follow` モジュールから `follow` 関数をインポートします。
- `import csv`: Python で CSV ファイルを読み書きするための `csv` モジュールをインポートします。
- `lines = follow('stocklog.csv')`: `stocklog.csv` というファイル名を引数に `follow` 関数を呼び出します。`follow` 関数は、ファイルに新しい行が追加されるたびにその行を生成するジェネレータを返します。
- `rows = csv.reader(lines)`: `csv.reader()` 関数は、`follow` 関数によって生成された行を受け取り、それらを CSV データの行に解析します。
- `for` ループはこれらの行を反復処理し、各行を出力します。

### ステップ 4: 出力を確認する

コードを実行すると、以下のような出力が表示されます（データは異なる場合があります）。

```
['BA', '98.35', '6/11/2007', '09:41.07', '0.16', '98.25', '98.35', '98.31', '158148']
['AA', '39.63', '6/11/2007', '09:41.07', '-0.03', '39.67', '39.63', '39.31', '270224']
['XOM', '82.45', '6/11/2007', '09:41.07', '-0.23', '82.68', '82.64', '82.41', '748062']
['PG', '62.95', '6/11/2007', '09:41.08', '-0.12', '62.80', '62.97', '62.61', '454327']
...
```

この出力は、データパイプラインが正常に作成されたことを示しています。`follow()` 関数がファイルから行を生成し、これらの行は `csv.reader()` 関数に渡され、データの行に解析されます。

出力を十分に確認したら、`Ctrl+C` を押して実行を停止できます。

## 何が起こっているのか？

このパイプラインで何が起こっているかを分解してみましょう。

1. `follow('stocklog.csv')` はジェネレータを作成します。このジェネレータは `stocklog.csv` ファイルを追跡し、ファイルに新しい行が追加されるたびにその行を生成します。
2. `csv.reader(lines)` は、`follow` 関数によって生成された行を受け取り、それらを CSV の行データに解析します。この関数は CSV ファイルの構造を理解し、行を個々の値に分割します。
3. `for` ループはこれらの行を反復処理し、各行を出力します。これにより、データを読みやすい形式で確認することができます。

これは、ジェネレータを使用したデータ処理パイプラインの簡単な例です。次のステップでは、より複雑で有用なパイプラインを構築します。
