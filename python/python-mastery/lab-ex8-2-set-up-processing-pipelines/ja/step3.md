# より複雑なデータパイプラインの構築

ここでは、データパイプラインにフィルタリング機能を追加し、データの表示を改善することで、パイプラインを次のレベルに引き上げます。これにより、扱っている情報の分析と理解が容易になります。`ticker.py` スクリプトに変更を加えます。データをフィルタリングすることで、関心のある特定の情報に焦点を当てることができ、整形された表形式で表示することで、データの読みやすさが向上します。

## ticker.py ファイルの更新

1. まず、WebIDE で `ticker.py` ファイルを開きます。WebIDE は、ブラウザ内で直接コードを記述および編集できるツールです。Python スクリプトに変更を加えるのに便利な環境を提供します。

2. 次に、`ticker.py` ファイル内の `if __name__ == '__main__':` ブロックを以下のコードに置き換えます。このコードブロックはスクリプトのエントリポイントであり、置き換えることで、スクリプトがデータを処理および表示する方法が変わります。

```python
if __name__ == '__main__':
    from follow import follow
    import csv
    from tableformat import create_formatter, print_table

    formatter = create_formatter('text')

    lines = follow('stocklog.csv')
    rows = csv.reader(lines)
    records = (Ticker.from_row(row) for row in rows)
    negative = (rec for rec in records if rec.change < 0)
    print_table(negative, ['name', 'price', 'change'], formatter)
```

3. これらの変更を加えた後、ファイルを保存します。キーボードで `Ctrl+S` を押すか、メニューから「File」→「Save」を選択することができます。ファイルを保存することで、変更内容が保存され、後で実行することができます。

## 強化されたパイプラインの理解

この強化されたパイプラインが何を行っているかを詳しく見ていきましょう。各ステップを理解することで、コードの異なる部分がどのように連携してデータを処理および表示するかがわかります。

1. まず、`tableformat` モジュールから `create_formatter` と `print_table` をインポートします。このモジュールはすでに設定されており、データをきれいな表形式で整形して表示するための関数を提供します。

2. 次に、`create_formatter('text')` を使用してテキストフォーマッタを作成します。このフォーマッタは、データを読みやすい形式に整形するために使用されます。

3. では、パイプラインをステップごとに分解してみましょう。
   - `follow('stocklog.csv')` は、`stocklog.csv` ファイルから行を生成する関数です。ファイルを継続的に監視し、新しいデータが追加されると、行を 1 つずつ提供します。
   - `csv.reader(lines)` は、`follow` 関数によって生成された行を受け取り、行データに解析します。CSV ファイル内のデータはテキスト形式であるため、操作可能な構造化された形式に変換する必要があります。
   - `(Ticker.from_row(row) for row in rows)` は、各行のデータを `Ticker` オブジェクトに変換するジェネレータ式です。`Ticker` オブジェクトは株式を表し、株式の名前、価格、変動などの情報を含みます。
   - `(rec for rec in records if rec.change < 0)` は、`Ticker` オブジェクトをフィルタリングする別のジェネレータ式です。株価の変動が負のオブジェクトのみを保持します。これにより、価格が下落した株式に焦点を当てることができます。
   - `print_table(negative, ['name', 'price', 'change'], formatter)` は、フィルタリングされた `Ticker` オブジェクトを、先に作成したフォーマッタを使用して表形式に整形し、コンソールに表示します。

このパイプラインは、ジェネレータの強力さを示しています。ファイルからすべてのデータを一度にメモリにロードするのではなく、複数の操作（読み取り、解析、変換、フィルタリング）を連鎖させ、データを 1 つずつ処理します。これにより、メモリが節約され、コードがより効率的になります。

## 強化されたパイプラインの実行

更新されたコードを実行して結果を確認しましょう。

1. まず、ターミナルでプロジェクトディレクトリにいることを確認します。まだそこにいない場合は、以下のコマンドを使用して移動できます。

   ```bash
   cd /home/labex/project
   ```

2. プロジェクトディレクトリにいることを確認したら、以下のコマンドを使用して `ticker.py` スクリプトを実行します。

   ```bash
   python3 ticker.py
   ```

3. スクリプトを実行した後、ターミナルにきれいに整形された表が表示されるはずです。この表は、価格が下落した株式のみを表示します。

   ```
          name      price     change
    ---------- ---------- ----------
             C      53.12      -0.21
           UTX      70.04      -0.19
           AXP      62.86      -0.18
           MMM      85.72      -0.22
           MCD      51.38      -0.03
           WMT      49.85      -0.23
            KO       51.6      -0.07
           AIG      71.39      -0.14
            PG      63.05      -0.02
            HD      37.76      -0.19
   ```

出力を十分に確認し、スクリプトの実行を停止したい場合は、キーボードで `Ctrl+C` を押すことができます。

## ジェネレータパイプラインの強力さ

ここで構築したのは、強力なデータ処理パイプラインです。その機能をまとめてみましょう。

1. `stocklog.csv` ファイルを継続的に監視し、新しいデータを検出します。つまり、ファイルに新しいデータが追加されると、パイプラインが自動的にそれを処理します。
2. ファイルからの CSV データを構造化された `Ticker` オブジェクトに解析します。これにより、データの操作が容易になります。
3. 特定の条件（この場合は価格の下落）に基づいてデータをフィルタリングします。これにより、価値が低下している株式に焦点を当てることができます。
4. フィルタリングされたデータを読みやすい表形式で整形して表示します。これにより、データの分析と結論の導出が容易になります。

このパイプラインでジェネレータを使用する主な利点の 1 つは、最小限のメモリしか使用しないことです。ジェネレータは必要に応じて値を生成するため、一度にすべてのデータをメモリに格納する必要がありません。これは、各コンポーネントがデータを処理して次のコンポーネントに渡す Unix パイプに似ています。

ジェネレータはレゴブロックのようなものだと考えることができます。レゴブロックを積み重ねてさまざまな構造物を作るように、ジェネレータを組み合わせて強力なデータ処理ワークフローを作成することができます。このモジュール方式により、単純で再利用可能なコンポーネントから複雑なシステムを構築することができます。
