# 构建更复杂的数据管道

现在，我们将通过添加过滤功能和改进数据展示方式，将数据管道提升到一个新的水平。这将使你更易于分析和理解所处理的信息。我们将对 `ticker.py` 脚本进行修改。过滤数据有助于你专注于感兴趣的特定信息，而以格式良好的表格形式展示数据则会使其更具可读性。

## 更新 ticker.py 文件

1. 首先，在 WebIDE 中打开你的 `ticker.py` 文件。WebIDE 是一个允许你直接在浏览器中编写和编辑代码的工具。它为修改 Python 脚本提供了一个便捷的环境。

2. 接下来，你需要将 `ticker.py` 文件中的 `if __name__ == '__main__':` 代码块替换为以下代码。这个代码块是脚本的入口点，替换它将改变脚本处理和显示数据的方式。

```python
if __name__ == '__main__':
    from follow import follow
    import csv
    from tableformat import create_formatter, print_table

    formatter = create_formatter('text')

    lines = follow('stocklog.csv')
    rows = csv.reader(lines)
    records = (Ticker.from_row(row) for row in rows)
    negative = (rec for rec in records if rec.change < 0)
    print_table(negative, ['name', 'price', 'change'], formatter)
```

3. 完成这些更改后，保存文件。你可以按键盘上的 `Ctrl+S`，或者从菜单中选择“File” → “Save”。保存文件可确保你的更改得以保留，并且之后可以运行。

## 理解增强型管道

让我们仔细看看这个增强型管道的工作原理。理解每个步骤将帮助你了解代码的不同部分如何协同工作来处理和显示数据。

1. 首先，我们从 `tableformat` 模块导入 `create_formatter` 和 `print_table`。这个模块已经为你设置好了，它提供了一些函数，可帮助你将数据格式化为美观的表格并进行打印。

2. 然后，我们使用 `create_formatter('text')` 创建一个文本格式化器。这个格式化器将以易于阅读的方式格式化数据。

3. 现在，让我们逐步分解这个管道：
   - `follow('stocklog.csv')` 是一个函数，它从 `stocklog.csv` 文件中生成行。它会持续监控文件中的新数据，并逐行提供这些数据。
   - `csv.reader(lines)` 获取 `follow` 函数生成的行，并将它们解析为行数据。这是必要的，因为 CSV 文件中的数据是文本格式，我们需要将其转换为可处理的结构化格式。
   - `(Ticker.from_row(row) for row in rows)` 是一个生成器表达式，它将每行数据转换为一个 `Ticker` 对象。`Ticker` 对象代表一只股票，包含股票的名称、价格和价格变化等信息。
   - `(rec for rec in records if rec.change < 0)` 是另一个生成器表达式，用于过滤 `Ticker` 对象。它只保留股票价格变化为负的对象。这使你能够专注于价格下跌的股票。
   - `print_table(negative, ['name', 'price', 'change'], formatter)` 获取过滤后的 `Ticker` 对象，并使用我们之前创建的格式化器将它们格式化为表格。然后将表格打印到控制台。

这个管道展示了生成器的强大之处。我们不是一次性将文件中的所有数据加载到内存中，而是将多个操作（读取、解析、转换、过滤）链接在一起，逐个处理数据项。这节省了内存，使代码更高效。

## 运行增强型管道

让我们运行更新后的代码，看看结果如何。

1. 首先，确保你在终端中位于项目目录。如果你还不在该目录，可以使用以下命令导航到那里：

   ```bash
   cd /home/labex/project
   ```

2. 一旦你位于项目目录中，使用以下命令运行 `ticker.py` 脚本：

   ```bash
   python3 ticker.py
   ```

3. 运行脚本后，你应该会在终端中看到一个格式良好的表格。这个表格只显示价格变化为负的股票。

   ```
          name      price     change
    ---------- ---------- ----------
             C      53.12      -0.21
           UTX      70.04      -0.19
           AXP      62.86      -0.18
           MMM      85.72      -0.22
           MCD      51.38      -0.03
           WMT      49.85      -0.23
            KO       51.6      -0.07
           AIG      71.39      -0.14
            PG      63.05      -0.02
            HD      37.76      -0.19
   ```

如果你已经看到足够的输出，并且想停止脚本的执行，可以按键盘上的 `Ctrl+C`。

## 生成器管道的强大之处

我们在这里创建的是一个强大的数据处理管道。下面总结一下它的功能：

1. 它持续监控 `stocklog.csv` 文件中的新数据。这意味着当新数据添加到文件中时，管道会自动处理它。
2. 它将文件中的 CSV 数据解析为结构化的 `Ticker` 对象。这使得处理数据和对其执行操作更加容易。
3. 它根据特定条件过滤数据，在这种情况下，是价格变化为负的股票。这使你能够专注于正在贬值的股票。
4. 它将过滤后的数据格式化为可读的表格并进行展示。这使得分析数据和得出结论变得容易。

在这个管道中使用生成器的一个关键优势是它使用的内存极少。生成器按需生成值，这意味着它们不会一次性将所有数据存储在内存中。这类似于 Unix 管道，每个组件处理数据并将其传递给下一个组件。

你可以将生成器看作是乐高积木。就像你可以将乐高积木堆叠在一起创建不同的结构一样，你可以组合生成器来创建强大的数据处理工作流。这种模块化方法允许你从简单、可重用的组件构建复杂的系统。
