# Создание менеджера контекста

Менеджер контекста - это специальный тип объекта в Python. В Python объекты могут иметь различные методы, которые определяют их поведение. Менеджер контекста в частности определяет два важных метода: `__enter__` и `__exit__`. Эти методы работают совместно с оператором `with`. Оператор `with` используется для настройки определенного контекста для блока кода. Представьте, что он создает небольшую среду, где происходят определенные действия, и когда блок кода завершен, менеджер контекста занимается очисткой.

На этом этапе мы создадим менеджер контекста, который имеет очень полезную функцию. Он временно перенаправит стандартный вывод (`sys.stdout`). Стандартный вывод - это место, куда идет обычный вывод вашей Python-программы, обычно консоль. Перенаправив его, мы можем отправить вывод в файл вместо этого. Это удобно, когда вы хотите сохранить вывод, который иначе просто отобразится на консоли.

Сначала нам нужно создать новый файл для написания кода нашего менеджера контекста. Мы назовем этот файл `redirect.py`. Вы можете создать его, используя следующую команду в терминале:

```bash
touch /home/labex/project/redirect.py
```

Теперь, когда файл создан, откройте его в редакторе. После открытия добавьте следующий Python-код в файл:

```python
import sys

class redirect_stdout:
    def __init__(self, out_file):
        self.out_file = out_file

    def __enter__(self):
        self.stdout = sys.stdout
        sys.stdout = self.out_file
        return self.out_file

    def __exit__(self, ty, val, tb):
        sys.stdout = self.stdout
```

Разберем, что делает этот менеджер контекста:

1. `__init__`: Это метод инициализации. Когда мы создаем экземпляр класса `redirect_stdout`, мы передаем в него объект файла. Этот метод сохраняет этот объект файла в экземплярной переменной `self.out_file`. Таким образом, он запоминает, куда мы хотим перенаправить вывод.
2. `__enter__`:
   - Сначала он сохраняет текущий `sys.stdout`. Это важно, потому что нам нужно восстановить его позже.
   - Затем он заменяет текущий `sys.stdout` на наш объект файла. С этого момента любой вывод, который обычно бы отправлялся на консоль, будет направлен в файл.
   - Наконец, он возвращает объект файла. Это полезно, так как мы можем захотеть использовать объект файла внутри блока `with`.
3. `__exit__`:
   - Этот метод восстанавливает исходный `sys.stdout`. Таким образом, после завершения блока `with` вывод снова будет направляться на консоль, как обычно.
   - Он принимает три параметра: тип исключения (`ty`), значение исключения (`val`) и трассировку стека (`tb`). Эти параметры требуются протоколом менеджера контекста. Они используются для обработки любых исключений, которые могут возникнуть внутри блока `with`.

Теперь давайте протестируем наш менеджер контекста. Мы используем его для перенаправления вывода таблицы в файл. Сначала запустите интерпретатор Python:

```bash
python3
```

Затем выполните следующий Python-код в интерпретаторе:

```python
>>> import stock, reader, tableformat
>>> from redirect import redirect_stdout
>>> portfolio = reader.read_csv_as_instances('portfolio.csv', stock.Stock)
>>> formatter = tableformat.create_formatter('text')
>>> with redirect_stdout(open('out.txt', 'w')) as file:
...     tableformat.print_table(portfolio, ['name','shares','price'], formatter)
...     file.close()
...
>>> # Let's check the content of the output file
>>> print(open('out.txt').read())
      name     shares      price
---------- ---------- ----------
        AA        100       32.2
       IBM         50       91.1
       CAT        150      83.44
      MSFT        200      51.23
        GE         95      40.37
      MSFT         50       65.1
       IBM        100      70.44
```

Отлично! Наш менеджер контекста работал как ожидалось. Он успешно перенаправил вывод таблицы в файл `out.txt`.

Менеджеры контекста - это очень мощная функция в Python. Они помогают вам правильно управлять ресурсами. Вот несколько общих случаев использования менеджеров контекста:

- Файловые операции: Когда вы открываете файл, менеджер контекста может убедиться, что файл будет правильно закрыт, даже если произошла ошибка.
- Соединения с базами данных: Он может гарантировать, что соединение с базой данных будет закрыто после того, как вы закончите использовать его.
- Блокировки в многопоточных программах: Менеджеры контекста могут безопасно обрабатывать блокировку и разблокировку ресурсов.
- Временное изменение параметров среды: Вы можете изменить некоторые настройки для блока кода и затем автоматически восстановить их.

Этот шаблон очень важен, потому что он гарантирует, что ресурсы будут очищены, даже если внутри блока `with` произошло исключение.

После завершения тестирования вы можете выйти из интерпретатора Python:

```python
>>> exit()
```
