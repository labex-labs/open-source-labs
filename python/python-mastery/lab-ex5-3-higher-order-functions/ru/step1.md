# Понимание дублирования кода

Начнем с рассмотрения текущего кода в файле `reader.py`. В программировании изучение существующего кода является важным шагом для понимания того, как все работает, и для выявления областей, подлежащих улучшению. Вы можете открыть файл `reader.py` в WebIDE. Сделать это можно двумя способами. Вы можете кликнуть на файл в проводнике файлов, или выполнить следующие команды в терминале. Эти команды сначала переходят в директорию проекта, а затем отображают содержимое файла `reader.py`.

```bash
cd ~/project
cat reader.py
```

При рассмотрении кода вы заметите, что там есть две функции. Функции в Python - это блоки кода, выполняющие определенную задачу. Вот эти две функции и их назначение:

1. `csv_as_dicts()`: Эта функция принимает данные в формате CSV и преобразует их в список словарей. Словарь в Python - это коллекция пар ключ - значение, которая полезна для хранения данных в структурированном виде.
2. `csv_as_instances()`: Эта функция принимает данные в формате CSV и преобразует их в список экземпляров. Экземпляр - это объект, созданный из класса, который является шаблоном для создания объектов.

Теперь давайте более подробно рассмотрим эти две функции. Вы увидите, что они очень похожи. Обе функции выполняют следующие шаги:

- Сначала они инициализируют пустой список `records`. Список в Python - это коллекция элементов, которые могут быть разных типов. Инициализация пустого списка означает создание списка без элементов, который будет использоваться для хранения обработанных данных.
- Затем они используют `csv.reader()` для разбора входных данных. Разбор означает анализ входных данных для извлечения значимой информации. В этом случае `csv.reader()` помогает нам считывать данные CSV построчно.
- Они обрабатывают заголовки одинаково. Заголовки в файле CSV - это первая строка, которая обычно содержит имена столбцов.
- Затем они перебирают каждую строку в данных CSV. Цикл - это конструкция программирования, которая позволяет выполнять блок кода несколько раз.
- Для каждой строки они обрабатывают ее, чтобы создать запись. Эта запись может быть либо словарем, либо экземпляром, в зависимости от функции.
- Они добавляют запись в список `records`. Добавление означает добавление элемента в конец списка.
- Наконец, они возвращают список `records`, который содержит все обработанные данные.

Это дублирование кода представляет проблему по нескольким причинам. Когда код дублируется:

- Его становится сложнее поддерживать. Если вам нужно внести изменения в код, вы должны сделать те же изменения в нескольких местах. Это требует больше времени и усилий.
- Любые изменения должны быть внесены в нескольких местах. Это увеличивает вероятность того, что вы забудете внести изменения в одном из мест, что приведет к неконсистентному поведению.
- Также увеличивается вероятность появления ошибок. Ошибки - это ошибки в коде, которые могут привести к неожиданному поведению.

Единственное реальное различие между этими двумя функциями - это то, как они преобразуют строку в запись. Это классическая ситуация, когда функция высшего порядка может быть очень полезной. Функция высшего порядка - это функция, которая может принимать другую функцию в качестве аргумента или возвращать функцию в качестве результата.

Давайте рассмотрим пример использования этих функций, чтобы лучше понять, как они работают. Следующий код показывает, как использовать `csv_as_dicts()` и `csv_as_instances()`:

```python
# Example of using csv_as_dicts
with open('portfolio.csv') as f:
    portfolio = csv_as_dicts(f, [str, int, float])
print(portfolio[0])  # {'name': 'AA', 'shares': 100, 'price': 32.2}

# Example of using csv_as_instances
class Stock:
    @classmethod
    def from_row(cls, row):
        return cls(row[0], int(row[1]), float(row[2]))

    def __init__(self, name, shares, price):
        self.name = name
        self.shares = shares
        self.price = price

with open('portfolio.csv') as f:
    portfolio = csv_as_instances(f, Stock)
print(portfolio[0].name, portfolio[0].shares, portfolio[0].price)  # AA 100 32.2
```

На следующем шаге мы создадим функцию высшего порядка, чтобы устранить это дублирование кода. Это сделает код более поддерживаемым и менее подверженным ошибкам.
