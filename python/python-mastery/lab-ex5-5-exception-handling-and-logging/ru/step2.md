# Реализация обработки исключений

На этом этапе мы сосредоточимся на том, чтобы сделать ваш код более надежным. Когда программа сталкивается с некорректными данными, она часто аварийно завершается. Но мы можем использовать технику, называемую обработкой исключений, чтобы элегантно справиться с этими проблемами. Вы будете модифицировать файл `reader.py` для реализации этой функциональности. Обработка исключений позволяет вашей программе продолжать работу даже при встрече с непредвиденными данными, вместо того чтобы резко останавливаться.

## Понимание блоков try-except

Python предоставляет мощный способ обработки исключений с использованием блоков try-except. Давайте разберемся, как они работают.

```python
try:
    # Code that might cause an exception
    result = risky_operation()
except SomeExceptionType as e:
    # Code that runs if the exception occurs
    handle_exception(e)
```

В блоке `try` вы помещаете код, который может вызвать исключение. Исключение - это ошибка, которая возникает во время выполнения программы. Например, если вы пытаетесь разделить число на ноль, Python вызовет исключение `ZeroDivisionError`. Когда исключение возникает в блоке `try`, Python останавливает выполнение кода в блоке `try` и переходит к соответствующему блоку `except`. Блок `except` содержит код, который обработает исключение. `SomeExceptionType` - это тип исключения, которое вы хотите поймать. Вы можете ловить конкретные типы исключений или использовать общий `Exception` для ловли всех типов исключений. Часть `as e` позволяет вам получить доступ к объекту исключения, который содержит информацию об ошибке.

## Модификация кода

Теперь давайте применим то, что мы узнали о блоках try-except, к функции `convert_csv()`. Откройте файл `reader.py` в своем редакторе.

1. Замените текущую функцию `convert_csv()` следующим кодом:

```python
def convert_csv(rows, converter, header=True):
    """
    Convert a sequence of rows to an output sequence according to a conversion function.
    """
    if header:
        headers = next(rows)
    else:
        headers = []

    result = []
    for row_idx, row in enumerate(rows, start=1):
        try:
            # Try to convert the row
            result.append(converter(headers, row))
        except Exception as e:
            # Print a warning message for bad rows
            print(f"Row {row_idx}: Bad row: {row}")
            continue

    return result
```

В этой новой реализации:

- Мы используем цикл `for` вместо `map()` для обработки каждой строки. Это дает нам больше контроля над обработкой каждой строки.
- Мы обернули код преобразования в блок try-except. Это означает, что если при преобразовании строки возникает исключение, программа не аварийно завершится. Вместо этого она перейдёт в блок `except`.
- В блоке `except` мы выводим сообщение об ошибке для некорректных строк. Это помогает нам определить, какие строки имеют проблемы.
- После вывода сообщения об ошибке мы используем оператор `continue`, чтобы пропустить текущую строку и продолжить обработку оставшихся строк.

Сохраните файл после внесения этих изменений.

## Тестирование ваших изменений

Давайте протестируем ваш модифицированный код с файлом `missing.csv`. Сначала откройте интерпретатор Python, выполнив следующую команду в терминале:

```bash
python3
```

После того, как вы находитесь в интерпретаторе Python, выполните следующий код:

```python
from reader import read_csv_as_dicts
port = read_csv_as_dicts('missing.csv', types=[str, int, float])
print(f"Number of valid rows processed: {len(port)}")
```

При выполнении этого кода вы должны увидеть сообщения об ошибках для каждой проблемной строки. Но программа продолжит обработку и вернет корректные строки. Вот пример того, что вы можете увидеть:

```
Row 4: Bad row: ['C', '', '53.08']
Row 7: Bad row: ['DIS', '50', 'N/A']
Row 8: Bad row: ['GE', '', '37.23']
Row 13: Bad row: ['INTC', '', '21.84']
Row 17: Bad row: ['MCD', '', '51.11']
Row 19: Bad row: ['MO', '', '70.09']
Row 22: Bad row: ['PFE', '', '26.40']
Row 26: Bad row: ['VZ', '', '42.92']
Number of valid rows processed: 20
```

Давайте также убедимся, что программа корректно работает с корректными данными. Выполните следующий код в интерпретаторе Python:

```python
valid_port = read_csv_as_dicts('valid.csv', types=[str, int, float])
print(f"Number of valid rows processed: {len(valid_port)}")
```

Вы должны увидеть, что все строки обрабатываются без ошибок. Вот пример вывода:

```
Number of valid rows processed: 17
```

Чтобы выйти из интерпретатора Python, выполните следующую команду:

```python
exit()
```

Теперь ваш код более надежен. Он может элегантно обрабатывать некорректные данные, пропуская плохие строки вместо аварийного завершения. Это делает вашу программу более надежной и удобной для пользователя.
