# 字典的内存分配

在 Python 中，和列表一样，字典也是一种基础的数据结构。理解字典的一个重要方面是它们如何进行内存分配。内存分配指的是 Python 如何在计算机内存中预留空间来存储字典中的数据。与列表类似，Python 字典也是以块为单位分配内存的。让我们来探究一下字典的内存分配是如何工作的。

1. 首先，我们需要创建一个字典来进行操作。在同一个 Python shell 中（如果你关闭了它，也可以打开一个新的），我们将创建一个表示数据记录的字典。Python 中的字典是键值对的集合，其中每个键都是唯一的，用于访问其对应的值。

```python
import sys  # Import sys if you're starting a new session
row = {'route': '22', 'date': '01/01/2001', 'daytype': 'U', 'rides': 7354}
```

在这里，我们导入了 `sys` 模块，它提供了对 Python 解释器使用或维护的一些变量的访问，以及与解释器进行强交互的函数。然后，我们创建了一个名为 `row` 的字典，其中包含四个键值对。

2. 现在我们有了字典，我们想检查它的初始大小。字典的大小指的是它在计算机中占用的内存量。

```python
sys.getsizeof(row)
```

`sys.getsizeof()` 函数以字节为单位返回对象的大小。当你运行这段代码时，你应该会看到一个大约为 `240` 字节的值。这能让你了解字典最初占用了多少内存。

3. 接下来，我们将向字典中添加新的键值对，并观察内存分配的变化。向字典中添加项是一个常见的操作，理解它对内存的影响至关重要。

```python
row['a'] = 1
sys.getsizeof(row)  # Size might remain the same

row['b'] = 2
sys.getsizeof(row)  # Size may increase
```

当你添加第一个键值对 (`'a': 1`) 时，字典的大小可能保持不变。这是因为 Python 已经分配了一定的内存块，并且该内存块中可能有足够的空间来容纳新项。然而，当你添加第二个键值对 (`'b': 2`) 时，大小可能会增加。你会注意到，在添加了一定数量的项之后，字典的大小会突然增加。这是因为字典和列表一样，以块为单位分配内存以优化性能。以块为单位分配内存可以减少 Python 向系统请求更多内存的次数，从而加快添加新项的过程。

4. 让我们尝试从字典中删除一个项，看看内存使用量是否会减少。从字典中删除项也是一个常见的操作，观察它对内存的影响很有趣。

```python
del row['b']
sys.getsizeof(row)
```

有趣的是，删除一个项通常不会减少内存分配。这是因为 Python 会保留已分配的内存，以避免在再次添加项时进行重新分配。从性能角度来看，重新分配内存是一个相对昂贵的操作，因此 Python 会尽量避免这种情况。

**内存效率考虑：**

当处理需要创建大量记录的大型数据集时，为每个记录使用字典可能不是最节省内存的方法。字典非常灵活且易于使用，但它们可能会消耗大量的内存，尤其是在处理大量记录时。以下是一些内存消耗较少的替代方案：

- 元组（Tuples）：简单的不可变序列。元组是一个值的集合，一旦创建就不能更改。它比字典使用的内存更少，因为它不需要存储键并管理相关的键值映射。
- 命名元组（Named tuples）：带有字段名的元组。命名元组与普通元组类似，但它们允许你通过名称访问值，这可以使代码更具可读性。它们也比字典使用的内存更少。
- 使用 `__slots__` 的类：显式定义属性以避免使用字典来存储实例变量的类。当你在类中使用 `__slots__` 时，Python 不会创建字典来存储实例变量，从而减少了内存使用。

在处理大量记录时，这些替代方案可以显著减少内存使用。
