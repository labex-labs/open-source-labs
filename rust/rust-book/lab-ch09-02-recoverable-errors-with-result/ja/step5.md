# エラーの伝播

関数の実装が失敗する可能性のある何かを呼び出す場合、関数自体の中でエラーを処理する代わりに、エラーを呼び出し元のコードに返して、それが何をするかを決定させることができます。これは「エラーを伝播する」と呼ばれ、呼び出し元のコードにより多くの制御を与えます。呼び出し元のコードでは、エラーをどのように処理するかを決定するための、コードのコンテキストで利用できる情報やロジックが、自分のコードのコンテキストよりも多い場合があります。

たとえば、リスト 9-6 は、ファイルからユーザー名を読み取る関数を示しています。ファイルが存在しない場合や読み取れない場合、この関数はそれらのエラーを関数を呼び出したコードに返します。

ファイル名：`src/main.rs`

```rust
use std::fs::File;
use std::io::{self, Read};

1 fn read_username_from_file() -> Result<String, io::Error> {
  2 let username_file_result = File::open("hello.txt");

  3 let mut username_file = match username_file_result {
      4 Ok(file) => file,
      5 Err(e) => return Err(e),
    };

  6 let mut username = String::new();

  7 match username_file.read_to_string(&mut username) {
      8 Ok(_) => Ok(username),
      9 Err(e) => Err(e),
    }
}
```

リスト 9-6: `match` を使ってエラーを呼び出し元のコードに返す関数

この関数は、はるかに短い方法で書くことができますが、エラー処理を調べるために、最初は手動で多くのことを行います。最後に、短い方法を示します。まず、関数の戻り値の型を見てみましょう。`Result<String, io::Error>` \[1\]。これは、関数が `Result<T, E>` 型の値を返していることを意味します。ここで、ジェネリックパラメータ `T` は具体的な型 `String` で埋められ、ジェネリック型 `E` は具体的な型 `io::Error` で埋められています。

この関数が問題なく成功した場合、この関数を呼び出すコードは、`String` を保持する `Ok` 値を受け取ります。この `String` は、この関数がファイルから読み取った `username` です \[8\]。この関数が何らかの問題に遭遇した場合、呼び出し元のコードは、問題の詳細を含む `io::Error` のインスタンスを保持する `Err` 値を受け取ります。この関数の戻り値の型として `io::Error` を選んだのは、この関数の本体で呼び出している 2 つの操作（`File::open` 関数 \[2\] と `read_to_string` メソッド \[7\]）のどちらかが失敗する可能性があるため、それらが返すエラー値の型が `io::Error` であるからです。

関数の本体は、まず `File::open` 関数を呼び出して始まります \[2\]。その後、リスト 9-4 の `match` と同じように、`Result` 値を処理します。`File::open` が成功した場合、パターン変数 `file` 内のファイルハンドル \[4\] が、ミュータブル変数 `username_file` 内の値になり \[3\]、関数は続行します。`Err` の場合、`panic!` を呼び出す代わりに、`return` キーワードを使って関数を完全に早期に返し、`File::open` からのエラー値（今はパターン変数 `e` 内）を、この関数のエラー値として呼び出し元のコードに渡します \[5\]。

したがって、`username_file` にファイルハンドルがある場合、関数は変数 `username` 内に新しい `String` を作成し \[6\]、`username_file` 内のファイルハンドルに対して `read_to_string` メソッドを呼び出して、ファイルの内容を `username` に読み込みます \[7\]。`read_to_string` メソッドも `Result` を返すため、`File::open` が成功したとしても、失敗する可能性があります。したがって、その `Result` を処理するために別の `match` が必要です。`read_to_string` が成功した場合、関数は成功したことになり、`Ok` にラップされた `username` 内のファイルからのユーザー名を返します。`read_to_string` が失敗した場合、`File::open` の戻り値を処理する `match` でエラー値を返すのと同じ方法で、エラー値を返します。ただし、これが関数の最後の式であるため、明示的に `return` を書く必要はありません \[9\]。

その後、このコードを呼び出すコードは、ユーザー名を含む `Ok` 値または `io::Error` を含む `Err` 値を取得します。それらの値をどうするかは、呼び出し元のコードが決定します。呼び出し元のコードが `Err` 値を取得した場合、`panic!` を呼び出してプログラムをクラッシュさせるか、既定のユーザー名を使用するか、ファイル以外の場所からユーザー名を検索するなど、何かを行うことができます。呼び出し元のコードが実際に何を試行しているかに関する情報が十分でないため、すべての成功またはエラー情報を上方に伝播させて、それが適切に処理できるようにします。

エラーを伝播するこのパターンは、Rust で非常に一般的であるため、Rust はこれを簡単にするために疑問符演算子 `?` を提供しています。
