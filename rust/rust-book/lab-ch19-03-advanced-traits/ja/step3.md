# デフォルトのジェネリック型パラメータと演算子のオーバーロード

ジェネリック型パラメータを使用する場合、ジェネリック型に対してデフォルトの具体的な型を指定することができます。これにより、デフォルトの型が機能する場合、トレイトの実装者が具体的な型を指定する必要がなくなります。`<`プレースホルダ型`=`具体的な型`>`の構文を使ってジェネリック型を宣言する際に、デフォルトの型を指定します。

この技術が役立つ状況の良い例は、*演算子のオーバーロード*です。これは、特定の状況下で演算子（たとえば`+`）の動作をカスタマイズするものです。

Rustでは、独自の演算子を作成したり、任意の演算子をオーバーロードしたりすることはできません。ただし、`std::ops`に列挙されている演算と対応するトレイトを、その演算子に関連付けられたトレイトを実装することでオーバーロードすることができます。たとえば、リスト19-14では、2つの`Point`インスタンスを加算するために`+`演算子をオーバーロードしています。これは、`Point`構造体に対して`Add`トレイトを実装することで行っています。

ファイル名：`src/main.rs`

```rust
use std::ops::Add;

#[derive(Debug, Copy, Clone, PartialEq)]
struct Point {
    x: i32,
    y: i32,
}

impl Add for Point {
    type Output = Point;

    fn add(self, other: Point) -> Point {
        Point {
            x: self.x + other.x,
            y: self.y + other.y,
        }
    }
}

fn main() {
    assert_eq!(
        Point { x: 1, y: 0 } + Point { x: 2, y: 3 },
        Point { x: 3, y: 3 }
    );
}
```

リスト19-14：`Point`インスタンス用に`+`演算子をオーバーロードするために`Add`トレイトを実装する

`add`メソッドは、2つの`Point`インスタンスの`x`値と2つの`Point`インスタンスの`y`値を加算して、新しい`Point`を作成します。`Add`トレイトには、`add`メソッドから返される型を決定する`Output`という名前の関連型があります。

このコードのデフォルトのジェネリック型は、`Add`トレイトの中にあります。以下はその定義です：

    trait Add<Rhs=Self> {
        type Output;

        fn add(self, rhs: Rhs) -> Self::Output;
    }

このコードは一般的におなじみのものに見えるはずです：1つのメソッドと関連型を持つトレイトです。新しい部分は`Rhs=Self`です。この構文は*デフォルト型パラメータ*と呼ばれます。`Rhs`ジェネリック型パラメータ（「右手側」の略）は、`add`メソッドの`rhs`パラメータの型を定義します。`Add`トレイトを実装する際に`Rhs`に具体的な型を指定しない場合、`Rhs`の型はデフォルトで`Self`になります。これは、`Add`を実装している型になります。

`Point`に対して`Add`を実装する際、2つの`Point`インスタンスを加えたかったので、`Rhs`のデフォルトを使用しました。`Rhs`型をカスタマイズしたい場合、デフォルトを使用しない`Add`トレイトの実装の例を見てみましょう。

異なる単位の値を保持する2つの構造体`Millimeters`と`Meters`があります。既存の型を別の構造体で薄くラップすることは、*ニュータイプパターン*と呼ばれ、「外部の型に対して外部のトレイトを実装するためのニュータイプパターンの使用」で詳しく説明しています。ミリメートルの値とメートルの値を加え、`Add`の実装が正しく変換するようにしたいと思います。`Rhs`として`Meters`を使って`Millimeters`に対して`Add`を実装することができます。リスト19-15を参照してください。

ファイル名：`src/lib.rs`

```rust
use std::ops::Add;

struct Millimeters(u32);
struct Meters(u32);

impl Add<Meters> for Millimeters {
    type Output = Millimeters;

    fn add(self, other: Meters) -> Millimeters {
        Millimeters(self.0 + (other.0 * 1000))
    }
}
```

リスト19-15：`Millimeters`と`Meters`を加算するために`Millimeters`に対して`Add`トレイトを実装する

`Millimeters`と`Meters`を加えるには、`Self`のデフォルトを使用する代わりに、`Rhs`型パラメータの値を設定するために`impl Add<Meters>`を指定します。

デフォルト型パラメータは主に2つの方法で使用します。

1.  既存のコードを破壊することなく型を拡張するため
2.  ほとんどのユーザーが必要としない特定のケースでのカスタマイズを可能にするため

標準ライブラリの`Add`トレイトは、2番目の目的の例です。通常、同じ型の2つを加えますが、`Add`トレイトはそれ以上のカスタマイズ機能を提供します。`Add`トレイトの定義でデフォルト型パラメータを使用することで、ほとんどの場合に余分なパラメータを指定する必要がなくなります。言い換えると、実装のボイラープレートが不要になり、トレイトの使用が容易になります。

最初の目的は、2番目と似ていますが逆です。既存のトレイトに型パラメータを追加したい場合、既存の実装コードを破壊することなくトレイトの機能を拡張できるように、デフォルトを与えることができます。
