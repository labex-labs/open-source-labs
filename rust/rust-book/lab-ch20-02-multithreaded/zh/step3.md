# 使用线程池提高吞吐量

线程池是一组已生成的线程，它们正在等待并准备好处理任务。当程序接收到一个新任务时，它会从线程池中分配一个线程来处理该任务，而该线程将处理这个任务。在线程处理第一个任务时，线程池中的其余线程可用于处理任何其他进来的任务。当第一个线程完成其任务处理后，它会返回到空闲线程池中，准备处理新任务。线程池允许你并发处理连接，从而提高服务器的吞吐量。

我们会将线程池中的线程数量限制为一个较小的数字，以防范拒绝服务（DoS）攻击；如果我们让程序在每个请求进来时都创建一个新线程，那么向我们的服务器发送一千万个请求的人可能会耗尽我们服务器的所有资源，使请求处理陷入停顿，从而造成严重破坏。

因此，我们不会生成无限制的线程，而是让固定数量的线程在线程池中等待。进来的请求会被发送到线程池进行处理。线程池将维护一个传入请求的队列。线程池中的每个线程都会从这个队列中取出一个请求，处理该请求，然后再向队列请求另一个请求。通过这种设计，我们可以并发处理多达N个请求，其中N是线程的数量。如果每个线程都在响应一个长时间运行的请求，后续请求仍可能在队列中排队，但在达到这一点之前，我们已经增加了可以处理的长时间运行请求的数量。

这种技术只是提高Web服务器吞吐量的众多方法之一。你可能会探索的其他选项包括fork/join模型、单线程异步I/O模型和多线程异步I/O模型。如果你对这个主题感兴趣，可以阅读更多关于其他解决方案的内容并尝试实现它们；使用像Rust这样的低级语言，所有这些选项都是可行的。

在我们开始实现线程池之前，让我们先讨论一下使用线程池应该是什么样子。当你试图设计代码时，先编写客户端接口可以帮助指导你的设计。编写代码的API，使其结构符合你想要调用它的方式；然后在该结构内实现功能，而不是先实现功能然后再设计公共API。

类似于我们在第12章的项目中使用测试驱动开发的方式，我们在这里将使用编译器驱动开发。我们将编写调用我们想要的函数的代码，然后查看编译器的错误，以确定接下来我们应该更改什么以使代码能够运行。然而，在我们这样做之前，我们将先探讨一下我们不会使用的技术作为起点。
