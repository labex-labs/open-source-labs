# Повышение пропускной способности с помощью пула потоков

Пул потоков - это группа запущенных потоков, которые ожидают и готовы обработать задачу. Когда программа получает новую задачу, она назначает один из потоков в пуле этой задаче, и этот поток обработает задачу. Оставшиеся потоки в пуле доступны для обработки любых других задач, которые поступают, пока первый поток обрабатывает свою задачу. Когда первый поток закончит обработку своей задачи, он возвращается в пул неактивных потоков, готовых обработать новую задачу. Пул потоков позволяет обрабатывать соединения одновременно, увеличивая пропускную способность сервера.

Мы ограничим количество потоков в пуле небольшим числом, чтобы защититься от DoS-атаки; если бы мы заставляли нашу программу создавать новый поток для каждого входящего запроса, кто-то, отправивший 10 миллионов запросов на наш сервер, мог бы создать хаос, израсходовав все ресурсы сервера и остановив обработку запросов.

Вместо создания неограниченного количества потоков мы будем иметь фиксированное количество потоков, ожидающих в пуле. Входящие запросы отправляются в пул для обработки. Пул будет поддерживать очередь входящих запросов. Каждый из потоков в пуле будет забирать запрос из этой очереди, обрабатывать запрос и затем запрашивать у очереди другой запрос. С такой архитектурой мы можем обрабатывать до N запросов одновременно, где N - количество потоков. Если каждый поток отвечает на длительный запрос, последующие запросы могут по-прежнему накапливаться в очереди, но мы увеличили количество длительных запросов, которые мы можем обработать, прежде чем дойти до этого момента.

Этот метод - это лишь один из многих способов повышения пропускной способности веб-сервера. Другие варианты, которые вы можете изучить, - это модель fork/join, модель однопоточного асинхронного ввода-вывода и модель многопоточного асинхронного ввода-вывода. Если вы заинтересованы в этой теме, вы можете прочитать больше о других решениях и попробовать их реализовать; с низкоуровневым языком, таким как Rust, все эти варианты возможны.

Прежде чем мы начнем реализовывать пул потоков, поговорим, как должен выглядеть вызов пула. Когда вы пытаетесь спроектировать код, сначала написать интерфейс клиента может помочь в вашем проекте. Напишите API кода таким образом, чтобы он был структурирован в том виде, в котором вы хотите его вызывать; затем реализуйте функциональность внутри этой структуры, а не сначала реализовать функциональность, а затем проектировать публичный API.

Похожим на то, как мы использовали тестирование на основе требований в проекте в главе 12, здесь мы будем использовать разработку на основе компилятора. Мы напишем код, который вызывает функции, которые мы хотим, а затем посмотрим на ошибки компилятора, чтобы определить, что мы должны изменить дальше, чтобы код заработал. Однако, прежде чем мы это сделаем, мы рассмотрим метод, который мы не собираемся использовать, в качестве точки отсчета.
