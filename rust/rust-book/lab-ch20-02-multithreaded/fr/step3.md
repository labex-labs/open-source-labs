# Improving Throughput with a Thread Pool

Un _thread pool_ est un groupe de threads lancés qui sont en attente et prêts à traiter une tâche. Lorsque le programme reçoit une nouvelle tâche, il attribue l'une des threads du pool à la tâche, et ce thread traitera la tâche. Les autres threads du pool sont disponibles pour traiter toute autre tâche qui arrive tandis que le premier thread est en train de traiter. Lorsque le premier thread a fini de traiter sa tâche, il est renvoyé dans le pool de threads inactifs, prêt à traiter une nouvelle tâche. Un thread pool vous permet de traiter les connexions de manière concurrente, augmentant le débit de votre serveur.

Nous limiterons le nombre de threads dans le pool à un nombre réduit pour nous protéger contre les attaques DoS ; si nous avions notre programme créer un nouveau thread pour chaque requête qui arrive, quelqu'un qui envoie 10 millions de requêtes à notre serveur pourrait causer des désordres en utilisant toutes les ressources de notre serveur et en arrêtant le traitement des requêtes.

Plutôt que de lancer un nombre illimité de threads, nous aurons donc un nombre fixe de threads en attente dans le pool. Les requêtes qui arrivent sont envoyées dans le pool pour traitement. Le pool maintiendra une file d'attente de requêtes entrantes. Chacun des threads dans le pool retira une requête de cette file, traitera la requête, puis demandera à la file une autre requête. Avec cette conception, nous pouvons traiter jusqu'à N requêtes en même temps, où N est le nombre de threads. Si chaque thread répond à une requête longue durée, les requêtes suivantes peuvent toujours se geler dans la file d'attente, mais nous avons augmenté le nombre de requêtes à longue durée que nous pouvons traiter avant d'arriver à ce point.

Cette technique n'est qu'un des nombreux moyens d'améliorer le débit d'un serveur web. D'autres options que vous pourriez explorer sont le modèle fork/join, le modèle d'entrée/sortie asynchrone mono-fil et le modèle d'entrée/sortie asynchrone multi-fil. Si vous êtes intéressé par ce sujet, vous pouvez en lire plus sur d'autres solutions et essayer de les implémenter ; avec un langage de bas niveau comme Rust, toutes ces options sont possibles.

Avant de commencer à implémenter un thread pool, parlons de ce que devrait ressembler l'utilisation du pool. Lorsque vous essayez de concevoir du code, écrire d'abord l'interface client peut aider à guider votre conception. Écrivez l'API du code de manière à ce qu'elle soit structurée comme vous voulez l'appeler ; puis implémentez la fonctionnalité dans cette structure plutôt que d'implémenter la fonctionnalité puis de concevoir l'API publique.

De manière similaire à la façon dont nous avons utilisé le développement piloté par les tests dans le projet du Chapitre 12, nous utiliserons ici le développement piloté par le compilateur. Nous écrirons le code qui appelle les fonctions que nous voulons, puis nous examinerons les erreurs du compilateur pour déterminer ce que nous devrions changer ensuite pour que le code fonctionne. Avant de le faire, cependant, nous explorerons la technique que nous ne allons pas utiliser comme point de départ.
