# Melhorando a Vazão com um Pool de Threads

Um _pool de threads_ é um grupo de threads geradas que estão esperando e prontas para lidar com uma tarefa. Quando o programa recebe uma nova tarefa, ele atribui uma das threads no pool à tarefa, e essa thread processará a tarefa. As threads restantes no pool estão disponíveis para lidar com quaisquer outras tarefas que chegarem enquanto a primeira thread está processando. Quando a primeira thread termina de processar sua tarefa, ela é retornada ao pool de threads ociosas, pronta para lidar com uma nova tarefa. Um pool de threads permite que você processe conexões simultaneamente, aumentando a vazão do seu servidor.

Limitaremos o número de threads no pool a um número pequeno para nos proteger de ataques DoS; se tivéssemos nosso programa criando uma nova thread para cada requisição que chegasse, alguém fazendo 10 milhões de requisições ao nosso servidor poderia causar estragos usando todos os recursos do nosso servidor e paralisando o processamento das requisições.

Em vez de gerar threads ilimitadas, então, teremos um número fixo de threads esperando no pool. As requisições que chegam são enviadas ao pool para processamento. O pool manterá uma fila de requisições recebidas. Cada uma das threads no pool retirará uma requisição dessa fila, lidará com a requisição e, em seguida, pedirá outra requisição à fila. Com este design, podemos processar até N requisições simultaneamente, onde N é o número de threads. Se cada thread estiver respondendo a uma requisição de longa duração, as requisições subsequentes ainda podem ficar presas na fila, mas aumentamos o número de requisições de longa duração que podemos lidar antes de chegar a esse ponto.

Esta técnica é apenas uma das muitas maneiras de melhorar a vazão de um servidor web. Outras opções que você pode explorar são o modelo fork/join, o modelo de I/O assíncrono de thread único e o modelo de I/O assíncrono multithreaded. Se você estiver interessado neste tópico, pode ler mais sobre outras soluções e tentar implementá-las; com uma linguagem de baixo nível como Rust, todas essas opções são possíveis.

Antes de começarmos a implementar um pool de threads, vamos falar sobre como o uso do pool deve ser. Quando você está tentando projetar código, escrever a interface do cliente primeiro pode ajudar a orientar seu design. Escreva a API do código para que ela seja estruturada da maneira que você deseja chamá-la; então, implemente a funcionalidade dentro dessa estrutura, em vez de implementar a funcionalidade e, em seguida, projetar a API pública.

Semelhante a como usamos o desenvolvimento orientado a testes no projeto no Capítulo 12, usaremos o desenvolvimento orientado a compilador aqui. Escreveremos o código que chama as funções que queremos e, em seguida, analisaremos os erros do compilador para determinar o que devemos mudar em seguida para fazer o código funcionar. Antes de fazermos isso, no entanto, exploraremos a técnica que não usaremos como ponto de partida.
