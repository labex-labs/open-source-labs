# Die Durchsatzleistung mit einem Threadpool verbessern

Ein _Threadpool_ ist eine Gruppe von erzeugten Threads, die darauf warten und bereit sind, eine Aufgabe zu verarbeiten. Wenn das Programm eine neue Aufgabe erhält, weist es einen der Threads im Pool der Aufgabe zu, und dieser Thread wird die Aufgabe verarbeiten. Die verbleibenden Threads im Pool sind verfügbar, um alle anderen Aufgaben zu verarbeiten, die während der Verarbeitung des ersten Threads eintreffen. Wenn der erste Thread seine Aufgabe abgeschlossen hat, wird er in den Pool der inaktiven Threads zurückgegeben und ist bereit, eine neue Aufgabe zu verarbeiten. Ein Threadpool ermöglicht es Ihnen, Verbindungen gleichzeitig zu verarbeiten und erhöht die Durchsatzleistung Ihres Servers.

Wir werden die Anzahl der Threads im Pool auf eine geringe Anzahl begrenzen, um uns vor DoS-Angriffen zu schützen; wenn unser Programm für jede eingehende Anfrage einen neuen Thread erstellt, könnte jemand, der 10 Millionen Anfragen an unseren Server sendet, Chaos stiften, indem er alle Ressourcen unseres Servers aufbraucht und das Verarbeiten von Anfragen zum Erliegen bringt.

Anstatt unbegrenzte Threads zu erzeugen, werden wir daher eine feste Anzahl von Threads im Pool warten lassen. Eingehende Anfragen werden an den Pool zur Verarbeitung gesendet. Der Pool wird eine Warteschlange von eingehenden Anfragen aufrechterhalten. Jeder der Threads im Pool wird eine Anfrage aus dieser Warteschlange abholen, die Anfrage verarbeiten und dann die Warteschlange um eine weitere Anfrage bitten. Mit diesem Design können wir bis zu N Anfragen gleichzeitig verarbeiten, wobei N die Anzahl der Threads ist. Wenn jeder Thread auf eine langlaufende Anfrage antwortet, können nachfolgende Anfragen immer noch in der Warteschlange anstecken, aber wir haben die Anzahl der langlaufenden Anfragen erhöht, die wir behandeln können, bevor wir diesen Punkt erreichen.

Diese Technik ist nur eine von vielen Möglichkeiten, um die Durchsatzleistung eines Webservers zu verbessern. Andere Optionen, die Sie erkunden könnten, sind das Fork/Join-Modell, das ein-threadige asynchrone E/A-Modell und das multi-threadige asynchrone E/A-Modell. Wenn Sie an diesem Thema interessiert sind, können Sie mehr über andere Lösungen lesen und versuchen, sie umzusetzen; mit einer niedrigebereinigten Sprache wie Rust sind alle diese Optionen möglich.

Bevor wir beginnen, einen Threadpool zu implementieren, sprechen wir darüber, wie das Verwenden des Pools aussehen sollte. Wenn Sie versuchen, Code zu entwerfen, kann das Schreiben der Client-Schnittstelle zuerst bei Ihrem Entwurf helfen. Schreiben Sie die Schnittstelle des Codes so, dass er in der Weise strukturiert ist, wie Sie ihn aufrufen möchten; implementieren Sie dann die Funktionalität innerhalb dieser Struktur, anstatt die Funktionalität zu implementieren und dann die öffentliche Schnittstelle zu entwerfen.

Ähnlich wie wir in Kapitel 12 des Projekts testgetriebene Entwicklung verwendet haben, werden wir hier compilergetriebene Entwicklung verwenden. Wir werden den Code schreiben, der die Funktionen aufruft, die wir möchten, und dann werden wir die Fehler des Compilers betrachten, um zu bestimmen, was wir als nächstes ändern sollten, um den Code zum Laufen zu bringen. Bevor wir das tun, werden wir jedoch die Technik untersuchen, die wir nicht verwenden werden, als Ausgangspunkt.
